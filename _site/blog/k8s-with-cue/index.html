<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Simplifying Kubernetes Manifests with CUE Language</title>
		<meta name="author" content="Roman Kiselenko">
		<meta property="og:type" content="website">
		<meta property="og:site_name" content="rkiselenko.dev">
		<meta name="title" property="og:title" content="Simplifying Kubernetes Manifests with CUE Language">
		<meta name="description" property="og:description" content="Simplify, modularize, and elevate your Kubernetes experience with CUE Language â€“ your shortcut to mastering manifest management">
		<meta property="og:url" content="https://rkiselenko.dev/blog/k8s-with-cue/">
		<meta name="image" property="og:image" content="https://rkiselenko.dev/img/k8s-with-cue.jpg">
		<meta name="twitter:card" content="summary">
		<meta name="keywords" content="posts,golang,yaml,cue,kubernetes,k8s"/>
		<meta name="twitter:site" content="@shindu666">
		<meta name="twitter:image" content="https://rkiselenko.dev/img/k8s-with-cue.jpg">
		<link href="https://iosevka-webfonts.github.io/iosevka/iosevka.css" rel="stylesheet" />
		<link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
		<link rel="apple-touch-icon" href="/icons/apple-touch-icon.png"/>
		<link rel="manifest" href="/manifest.json" />
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Work+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="rkiselenko.dev">
		<link rel="alternate" href="/feed/feed.json" type="application/json" title="rkiselenko.dev">
		<style>/**
 * prism.js tomorrow night eighties for JavaScript, CoffeeScript, CSS and HTML
 * Based on https://github.com/chriskempson/tomorrow-theme
 * @author Rose Pritchard
 */

code[class*="language-"],
pre[class*="language-"] {
	color: #ccc;
	background: none;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;

}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #2d2d2d;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.block-comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: #999;
}

.token.punctuation {
	color: #ccc;
}

.token.tag,
.token.attr-name,
.token.namespace,
.token.deleted {
	color: #e2777a;
}

.token.function-name {
	color: #6196cc;
}

.token.boolean,
.token.number,
.token.function {
	color: #f08d49;
}

.token.property,
.token.class-name,
.token.constant,
.token.symbol {
	color: #f8c555;
}

.token.selector,
.token.important,
.token.atrule,
.token.keyword,
.token.builtin {
	color: #cc99cd;
}

.token.string,
.token.char,
.token.attr-value,
.token.regex,
.token.variable {
	color: #7ec699;
}

.token.operator,
.token.entity,
.token.url {
	color: #67cdcc;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}

.token.inserted {
	color: green;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
* { box-sizing: border-box; }
/* Defaults */

:root {
	--font-family: 'Work Sans', sans-serif;
	--font-family-monospace: 'Iosevka Web', monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #ffffff;

	--text-color: var(--color-gray-90);
	--text-color-link: #45a2ea;
	--text-color-link-active: #5f2b48;
	--text-color-link-visited: #735063;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #bbbbbb;
		--text-color-link-active: #818181;
		--text-color-link-visited: #19a4e9;

		--background-color: #15202b;
	}

	.github, .linkedin, .stackoverflow, .rss {
		fill: white;
	}

	code {
		background-color: var(--color-gray-50);
		color: var(--background-color);
		word-break: break-all;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 50em;
	min-width: 20em;
}

blockquote {
	margin-top: 10px;
	margin-bottom: 10px;
	margin-left: 0px;
	padding-left: 15px;
	border-left: 5px solid var(--text-color-link);
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

h1,h2,h3,h4 {
	margin-bottom: 0;
}

p:last-child {
	margin-bottom: 0;
}
p,li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
	font-weight: medium;
	text-decoration: none;
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main {
	padding: 1rem;
}
main :first-child {
	margin-top: 0;
}

header {
	border-bottom: 1px dashed var(--color-gray-20);
}
header:after {
	content: "";
	display: table;
	clear: both;
}

.links-nextprev {
	list-style: none;
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre[class*="language-"] {
	padding: 0.5em;
	line-height: 1.2; /* 22px /16 */
}
pre,
code {
	font-family: var(--font-family-monospace);
    /* border-radius: 5px; */
	white-space: nowrap;
	padding: 2px 2px 2px 2px;
    font-size: 0.8em;
}
code[class*="language-"] {
	padding: 0px;
}

pre,
code[class*="language-"] {
	font-family: var(--font-family-monospace);
	line-height: 1; /* 22px /16 */
    font-size: 0.9em;
}
pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.225; /* 22px /16 */
	font-family: var(--font-family-monospace);
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
}

code {
	background-color: var(--color-gray-50);
	word-break: break-all;
    border-radius: 3px;
}

/* Header */
header {
	display: flex;
	gap: 1em .5em;
	flex-wrap: wrap;
	align-items: center;
	padding: 1em;
}
.home-link {
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
	margin-right: 2em;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
	margin-right: 0.7em;
	white-space: nowrap;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}

.nav-item a[href]:hover {
    text-decoration: underline;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	list-style: none;
	padding: 0;
	padding-left: 1.5rem;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	content: "" counter(start-from, decimal-leading-zero) ". ";
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}

.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	padding-left: .25em;
	padding-right: .5em;
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	/* text-transform: capitalize; */
	font-style: italic;
}

a[href]:visited.post-tag {
	color: var(--text-color-link-visited);
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
	margin-block-start: 0.67em;
    margin-block-end: 0.67em;
}
.post-metadata time {
	margin-right: 1em;
	font-size: 0.85em;
}

/* Direct Links / Markdown Headers */
.header-anchor {
	text-decoration: none;
	font-style: normal;
	font-size: 1em;
	margin-left: .1em;
}
a[href].header-anchor,
a[href].header-anchor:visited {
	color: transparent;
}
a[href].header-anchor:focus,
a[href].header-anchor:hover {
	text-decoration: underline;
}
a[href].header-anchor:focus,
:hover > a[href].header-anchor {
	color: #aaa;
}

h2 + .header-anchor {
	font-size: 1.5em;
}

.ava img {
    -webkit-border-radius: 10px;
    -moz-border-radius: 10px;
    -ms-border-radius: 10px;
    -o-border-radius: 10px;
    border-radius: 10px;
  max-width: 20%;
}
.ava {
  width: 100%
}

/* .penguin {
  margin-top: 16px;
} */

.penguin img {
  width: 5%;
  max-width: 10%;
}

img {
  max-width: 100%;
}
img[width] {
  width: auto; /* Defer to max-width */
}
img[width][height] {
  height: auto; /* Preserve aspect ratio */
}

.codetitle {
	clear: right;
	float: right;
	padding: .25em 0 .25em .5em;
	border-radius: .25em .25em 0 0;
	font-family: var(--font-family-monospace);
	font-size: 0.85em; /* 12px /16 */
}
.codetitle-left {
	float: left;
	clear: left;
	padding-left: 0;
	padding-right: .5em;
}
.codetitle + pre {
	clear: both;
}
.codetitle {
	float: right;
	margin: 0 2em 0 0;
	padding: .25em 0;
	background-color: transparent;
	border-width: 0;
	box-shadow: none;
	font-size: 0.85em; /* 12px /16 */
	font-weight: 200;
}

.codetitle-left {
	float: left;
	margin-left: 0;
	margin-right: 0;
	position: relative;
	bottom: -2px;
}
.codetitle-left + .codetitle-left {
	clear: none;
	margin-left: 2em;
}
/* Message Box */
.message-box {
	--color-message-box: #ffc;

	display: block;
	background-color: var(--color-message-box);
	color: var(--color-gray-90);
	padding: 1em 0.625em; /* 16px 10px /16 */
}
.message-box ol {
	margin-top: 0;
}

@media (prefers-color-scheme: dark) {
	.message-box {
		--color-message-box: #082840;
	}
}</style>
	</head>
	<body>
		<a href="#skip" class="visually-hidden">Skip to main content</a>
		<header>
			<nav>
				<h2 class="visually-hidden">Top level navigation menu</h2>
					<ul class="nav">
						<li class="nav-item"><a href="/">Home</a></li>
						<li class="nav-item"><a href="/blog/">Archive</a></li>
						<li class="nav-item"><a href="/about/">About Me</a></li>
					<li class="nav-item"><a href="/CV.pdf" target="_blank" title="@roman-kiselenko resume">CV</a></li>
					<li class="nav-item">
						<a href="https://github.com/roman-kiselenko/" target="_blank" title="@roman-kiselenko on GitHub">
							<svg class="github" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
						</a>
					</li>
					<li class="nav-item">
						<a href="https://www.linkedin.com/in/roman-kiselenko/" target="_blank" title="roman-kiselenko on Linkedin">
							<svg class="linkedin" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-2 16h-2v-6h2v6zm-1-6.891c-.607 0-1.1-.496-1.1-1.109 0-.612.492-1.109 1.1-1.109s1.1.497 1.1 1.109c0 .613-.493 1.109-1.1 1.109zm8 6.891h-1.998v-2.861c0-1.881-2.002-1.722-2.002 0v2.861h-2v-6h2v1.093c.872-1.616 4-1.736 4 1.548v3.359z"/></svg>
						</a>
					</li>
					<li class="nav-item">
						<a href="https://stackoverflow.com/users/2057388/roman-kiselenko?tab=profile" target="_blank" title="roman-kiselenko on StackOverflow">
							<svg class="stackoverflow" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm.869 5.903l3.114 4.567-.975.665-3.115-4.567.976-.665zm-2.812 2.585l4.84 2.838-.6 1.017-4.842-2.838.602-1.017zm-1.276 2.724l5.413 1.521-.291 1.077-5.428-1.458.306-1.14zm-.588 2.461l5.687.569-.103 1.12-5.691-.513.107-1.176zm-.169 2.16h5.835v1.167h-5.835v-1.167zm7.976 3.167h-10v-6h1v5h8v-5h1v6zm.195-8.602l-.945-5.446 1.162-.202.947 5.446-1.164.202z"/></svg>
						</a>
					</li>
					<li class="nav-item">
						<a href="/feed/feed.xml" target="_blank" title="roman-kiselenko rss">
						 <svg class="rss" fill="#000000" height="20" width="20" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
								viewBox="-143 145 512 512" xml:space="preserve">
							<path d="M113,145c-141.4,0-256,114.6-256,256s114.6,256,256,256s256-114.6,256-256S254.4,145,113,145z M43.1,518.7
								c-6.2,6.2-14.7,9.9-24.1,9.9c-9.4,0-17.8-3.8-24-9.9c-6.2-6.2-10-14.6-10-23.9c0-9.4,3.8-17.8,10-24s14.6-10,24-10
								c9.4,0,17.9,3.8,24,10c6.2,6.2,10,14.6,10,24C53,504.2,49.2,512.6,43.1,518.7z M104.8,529c-0.1-32.1-12.5-62.3-35.1-84.9
								c-22.6-22.6-52.8-35.2-84.7-35.2V360c46.6,0,88.7,19,119.3,49.6c30.6,30.6,49.5,72.8,49.6,119.4H104.8z M192,529
								c-0.1-114.2-92.8-207.1-206.9-207.1V273c70.6,0,134.5,28.7,180.8,75.1c46.3,46.4,75,110.3,75.1,180.9H192z"/>
							</svg>
						</a>
					</li>
				</ul>
			</nav>
		</header>

		<main id="skip">
			
<h1>Simplifying Kubernetes Manifests with CUE Language</h1>

<ul class="post-metadata">
	<li><time datetime="2024-01-11">11 January 2024</time></li>
	<li><a href="/tags/golang/" class="post-tag">golang</a>, </li>
	<li><a href="/tags/yaml/" class="post-tag">yaml</a>, </li>
	<li><a href="/tags/cue/" class="post-tag">cue</a>, </li>
	<li><a href="/tags/kubernetes/" class="post-tag">kubernetes</a>, </li>
	<li><a href="/tags/k8s/" class="post-tag">k8s</a></li>
</ul>

<p><picture><source type="image/gif" srcset="/img/kEUsYWqPjE-900.gif 900w"><source type="image/avif" srcset="/img/kEUsYWqPjE-900.avif 900w"><source type="image/webp" srcset="/img/kEUsYWqPjE-900.webp 900w"><img alt="cue with kubernetes" loading="lazy" decoding="async" src="/img/kEUsYWqPjE-900.jpeg" width="900" height="808"></picture></p>
<p>At my day-to-day job, I work a lot with Kubernetes YAML manifests. At some point, the manifests management becomes cumbersome. Many duplications spread across different folders, especially if you have different environments that are supposed to be identical (production and staging, e.g.). Typos or, even worse, forgotten keys are a headache for engineers.</p>
<blockquote>
<p><small>CUE is not specific to Go, or to cloud applications, but like many of new cloud technologies, CUE is written in Go. It has a rich set of APIs available to Go developers and interacts with CUE in various ways.
<a href="https://cuelang.org/docs/integrations/go/#download-cue-definitions-from-go">cuelang.org</a></small></p>
</blockquote>
<p>Many tools are available for working with YAML manifests, like generating, composing, and distributing your Kubernetes resources. Here is a list of the most popular:</p>
<ul>
<li><a href="https://helm.sh/">helm</a> - Helm is a tool for managing Charts. Charts are packages of pre-configured Kubernetes resources.</li>
<li><a href="https://github.com/kubernetes-sigs/kustomize">kustomize</a> - Lets you customize raw, template-free YAML files for multiple purposes, leaving the original YAML untouched and usable as is.</li>
<li><a href="https://github.com/cdk8s-team/cdk8s">cdk8s</a> - Define Kubernetes native apps and abstractions using object-oriented programming.</li>
</ul>
<p>But those tools have cons:</p>
<ul>
<li><a href="https://helm.sh/">helm</a> - Helm templating system is based on Go, and you can't reproduce some tasks with the Go templating system, like YAML type validations or schema support.</li>
<li><a href="https://github.com/kubernetes-sigs/kustomize">kustomize</a> - Good just for composition,missing schema and validation support.</li>
<li><a href="https://github.com/cdk8s-team/cdk8s">cdk8s</a> - While this tool is good in some cases, I'm unsure if I need object-oriented programming to manage manifests; it's too much.</li>
</ul>
<p>What I want from the tool:</p>
<ol>
<li>Keep existed manifests untoched.</li>
<li>Prevent manual edits of manifests.</li>
<li>Keep manifests <a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">DRY</a>.</li>
<li>Validate manifests against predefined schema.</li>
<li>Generate new manifests without copy-pasts.</li>
</ol>
<p>Lets see if we can achive all of requirements above with CUE.</p>
<p>We'll start with simple YAML manifest:</p>
<pre class="language-yaml" tabindex="0"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> plainecho<span class="token punctuation">-</span>app
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> plainecho<span class="token punctuation">-</span>app
    <span class="token key atrule">domain</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">prometheus.io.scrape</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
    <span class="token key atrule">prometheus.io.port</span><span class="token punctuation">:</span> <span class="token string">"8081"</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> plainecho<span class="token punctuation">-</span>app
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> plainecho<span class="token punctuation">-</span>app
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> plainecho<span class="token punctuation">-</span>app 
        <span class="token key atrule">image</span><span class="token punctuation">:</span> plainecho<span class="token punctuation">:</span>latest
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8081</span>
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"100m"</span>
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
 <span class="token key atrule">name</span><span class="token punctuation">:</span> plainecho<span class="token punctuation">-</span>app
 <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> plainecho<span class="token punctuation">-</span>app
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>metrics
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8081</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> plainecho<span class="token punctuation">-</span>app</code></pre>
<p>This resource contains two objects <code>deployment</code> and <code>service</code>.
CUE will generate basic config with <code>import</code> command.</p>
<pre class="language-shell" tabindex="0"><code class="language-shell">cue <span class="token function">import</span> ./<span class="token punctuation">..</span>. <span class="token parameter variable">-p</span> plainecho <span class="token parameter variable">-l</span> <span class="token string">'strings.ToCamel(kind)'</span> <span class="token parameter variable">-l</span> metadata.name <span class="token parameter variable">-f</span></code></pre>
<div class="codetitle codetitle-left"><b>plainechosvc.cue </b></div>
<pre class="language-cue" tabindex="0"><code class="language-cue"><span class="token keyword">package</span> plainecho

deployment<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"plainecho-app"</span></span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
	apiVersion<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"apps/v1"</span></span>
	kind<span class="token punctuation">:</span>       <span class="token string-literal"><span class="token string">"Deployment"</span></span>
	metadata<span class="token punctuation">:</span> <span class="token punctuation">{</span>
		name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"plainecho-app"</span></span>
		labels<span class="token punctuation">:</span> <span class="token punctuation">{</span>
			app<span class="token punctuation">:</span>    <span class="token string-literal"><span class="token string">"plainecho-app"</span></span>
			domain<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"dev"</span></span>
		<span class="token punctuation">}</span>
		annotations<span class="token punctuation">:</span> <span class="token punctuation">{</span>
			<span class="token string-literal"><span class="token string">"prometheus.io.scrape"</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"true"</span></span>
			<span class="token string-literal"><span class="token string">"prometheus.io.port"</span></span><span class="token punctuation">:</span>   <span class="token string-literal"><span class="token string">"8081"</span></span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	spec<span class="token punctuation">:</span> <span class="token punctuation">{</span>
		replicas<span class="token punctuation">:</span> <span class="token number">2</span>
		selector<span class="token punctuation">:</span> matchLabels<span class="token punctuation">:</span> app<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"plainecho-app"</span></span>
		template<span class="token punctuation">:</span> <span class="token punctuation">{</span>
			metadata<span class="token punctuation">:</span> labels<span class="token punctuation">:</span> app<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"plainecho-app"</span></span>
			spec<span class="token punctuation">:</span> containers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
				name<span class="token punctuation">:</span>  <span class="token string-literal"><span class="token string">"plainecho-app"</span></span>
				image<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"plainecho:latest"</span></span>
				ports<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
					containerPort<span class="token punctuation">:</span> <span class="token number">8081</span>
				<span class="token punctuation">}</span><span class="token punctuation">]</span>
				resources<span class="token punctuation">:</span> requests<span class="token punctuation">:</span> cpu<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"100m"</span></span>
				imagePullPolicy<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"IfNotPresent"</span></span>
			<span class="token punctuation">}</span><span class="token punctuation">]</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
service<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"plainecho-app"</span></span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
	apiVersion<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"v1"</span></span>
	kind<span class="token punctuation">:</span>       <span class="token string-literal"><span class="token string">"Service"</span></span>
	metadata<span class="token punctuation">:</span> <span class="token punctuation">{</span>
		name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"plainecho-app"</span></span>
		labels<span class="token punctuation">:</span> app<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"plainecho-app"</span></span>
	<span class="token punctuation">}</span>
	spec<span class="token punctuation">:</span> <span class="token punctuation">{</span>
		ports<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
			port<span class="token punctuation">:</span>       <span class="token number">8081</span>
			name<span class="token punctuation">:</span>       <span class="token string-literal"><span class="token string">"http-metrics"</span></span>
			targetPort<span class="token punctuation">:</span> <span class="token number">8081</span>
			protocol<span class="token punctuation">:</span>   <span class="token string-literal"><span class="token string">"TCP"</span></span>
		<span class="token punctuation">}</span><span class="token punctuation">]</span>
		selector<span class="token punctuation">:</span> app<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"plainecho-app"</span></span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Now we need create some tooling in order to prepare for generation and refactoring.</p>
<div class="codetitle codetitle-left"><b>objects.cue </b></div>
<pre class="language-cue" tabindex="0"><code class="language-cue"><span class="token comment">// This will collect all objects from CUE configuration</span>
<span class="token keyword">package</span> plainecho

objects<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">for</span> v <span class="token keyword">in</span> objectSets <span class="token keyword">for</span> x <span class="token keyword">in</span> v <span class="token punctuation">{</span>x<span class="token punctuation">}</span><span class="token punctuation">]</span>

objectSets<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        deployment<span class="token punctuation">,</span>
        service<span class="token punctuation">,</span>
<span class="token punctuation">]</span></code></pre>
<div class="codetitle codetitle-left"><b>dump_tool.cue </b></div>
<pre class="language-cue" tabindex="0"><code class="language-cue"><span class="token comment">// This will use `objects.cue` and dump YAML to stdout</span>
<span class="token keyword">package</span> plainecho

<span class="token keyword">import</span> <span class="token punctuation">(</span>
        <span class="token string-literal"><span class="token string">"encoding/yaml"</span></span>
        <span class="token string-literal"><span class="token string">"tool/cli"</span></span>
<span class="token punctuation">)</span>

command<span class="token punctuation">:</span> dump<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        task<span class="token punctuation">:</span> print<span class="token punctuation">:</span> cli<span class="token punctuation">.</span>Print <span class="token operator">&amp;</span> <span class="token punctuation">{</span>
                text<span class="token punctuation">:</span> yaml<span class="token punctuation">.</span><span class="token function">MarshalStream</span><span class="token punctuation">(</span>objects<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>By using <code>cue cmd dump</code> the generated YAML will be printed to stdout.</p>
<p>Now we're ready to leverage CUE features ðŸ†’</p>

<ul class="links-nextprev"><li>Previous: <a href="/blog/define-validate-generate/">Define, Validate, Generate with CUE language</a></li><li>Next: <a href="/blog/development-on-mac-with-lima/">Development On Apple Silicon with Lima</a></li>
</ul>

		</main>

		<footer></footer>

		<!-- Current page: /blog/k8s-with-cue/ -->
	</body>
</html>
