{
	"version": "https://jsonfeed.org/version/1.1",
	"title": "rkiselenko.dev",
	"language": "en",
	"home_page_url": "https://rkiselenko.dev/",
	"feed_url": "https://rkiselenko.dev/feed/feed.json",
	"description": "Insights from the Daily Life of a Software Developer",
	"author": {
		"name": "Roman Kiselenko",
		"url": "https://rkiselenko.dev/about/"
	},
	"items": [
		{
			"id": "https://rkiselenko.dev/blog/crio-in-kind/",
			"url": "https://rkiselenko.dev/blog/crio-in-kind/",
			"title": "Use CRI-O Container Runtime with KIND",
			"content_html": "<div class=\"message-box\">\n<p>KIND uses containerd by default as container runtime, however, it is possible to switch it by CRI-O.</p>\n</div>\n<p><picture><source type=\"image/gif\" srcset=\"https://rkiselenko.dev/img/PVbfQEd4AS-900.gif 900w\"><source type=\"image/avif\" srcset=\"https://rkiselenko.dev/img/PVbfQEd4AS-900.avif 900w\"><source type=\"image/webp\" srcset=\"https://rkiselenko.dev/img/PVbfQEd4AS-900.webp 900w\"><img alt=\"crio-in-kind\" loading=\"lazy\" decoding=\"async\" src=\"https://rkiselenko.dev/img/PVbfQEd4AS-900.jpeg\" width=\"900\" height=\"822\"></picture></p>\n<p>In this article, I'll demonstrate how to build <a href=\"https://kind.sigs.k8s.io/docs/design/node-image/\">node image</a> with particular Kubernetes version and <a href=\"https://github.com/cri-o/cri-o\">cri-o</a> container runtime.</p>\n<h3 id=\"build-base-image\" tabindex=\"-1\">Build Base Image <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/crio-in-kind/\">#</a></h3>\n<p>We need <code>kind</code> sources in order to build the <code>base image</code>:</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\">$ <span class=\"token function\">git</span> clone git@github.com:kubernetes-sigs/kind.git\n$ <span class=\"token builtin class-name\">cd</span> kind/images/base\n$ <span class=\"token function\">make</span> quick\n./<span class=\"token punctuation\">..</span>/<span class=\"token punctuation\">..</span>/hack/build/init-buildx.sh\n<span class=\"token function\">docker</span> buildx build  <span class=\"token parameter variable\">--load</span> <span class=\"token parameter variable\">--progress</span><span class=\"token operator\">=</span>auto <span class=\"token parameter variable\">-t</span> gcr.io/k8s-staging-kind/base:v20240508-19df3db3 <span class=\"token parameter variable\">--pull</span> --build-arg <span class=\"token assign-left variable\">GO_VERSION</span><span class=\"token operator\">=</span><span class=\"token number\">1.21</span>.6  <span class=\"token builtin class-name\">.</span>\n<span class=\"token comment\">### ... some output here</span></code></pre>\n<p>The image <code>gcr.io/k8s-staging-kind/base:v20240508-19df3db3</code> is our <a href=\"https://kind.sigs.k8s.io/docs/design/base-image/\">base image</a>. We'll use it for <code>node image</code> building.</p>\n<h3 id=\"build-node-image\" tabindex=\"-1\">Build Node Image <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/crio-in-kind/\">#</a></h3>\n<p>Before start building <code>node image</code> we need kubernetes sources at <code>$GOPATH</code>.</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\">$ <span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> <span class=\"token string\">\"<span class=\"token variable\">$GOPATH</span>\"</span>/src/k8s.io/kubernetes\n$ <span class=\"token assign-left variable\">K8S_VERSION</span><span class=\"token operator\">=</span>v1.30.0\n$ <span class=\"token function\">git</span> clone <span class=\"token parameter variable\">--depth</span> <span class=\"token number\">1</span> <span class=\"token parameter variable\">--branch</span> <span class=\"token variable\">${K8S_VERSION}</span> https://github.com/kubernetes/kubernetes.git <span class=\"token string\">\"<span class=\"token variable\">$GOPATH</span>\"</span>/src/k8s.io/kubernetes</code></pre>\n<p>Now let's build node image:</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\">$ kind build node-image --base-image gcr.io/k8s-staging-kind/base:v20240508-19df3db3\nStarting to build Kubernetes\n+++ <span class=\"token punctuation\">[</span>0508 <span class=\"token number\">15</span>:41:04<span class=\"token punctuation\">]</span> Verifying Prerequisites<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>\n+++ <span class=\"token punctuation\">[</span>0508 <span class=\"token number\">15</span>:41:04<span class=\"token punctuation\">]</span> Building Docker image kube-build:build-14d7110ae1-5-v1.30.0-go1.22.2-bullseye.0\n+++ <span class=\"token punctuation\">[</span>0508 <span class=\"token number\">15</span>:42:49<span class=\"token punctuation\">]</span> Creating data container kube-build-data-14d7110ae1-5-v1.30.0-go1.22.2-bullseye.0\n+++ <span class=\"token punctuation\">[</span>0508 <span class=\"token number\">15</span>:42:50<span class=\"token punctuation\">]</span> Syncing sources to container\n+++ <span class=\"token punctuation\">[</span>0508 <span class=\"token number\">15</span>:42:54<span class=\"token punctuation\">]</span> Running build command<span class=\"token punctuation\">..</span>.\n+++ <span class=\"token punctuation\">[</span>0508 <span class=\"token number\">15</span>:42:46<span class=\"token punctuation\">]</span> Building go targets <span class=\"token keyword\">for</span> linux/arm64\n    k8s.io/kubernetes/cmd/kube-apiserver <span class=\"token punctuation\">(</span>static<span class=\"token punctuation\">)</span>\n    k8s.io/kubernetes/cmd/kube-controller-manager <span class=\"token punctuation\">(</span>static<span class=\"token punctuation\">)</span>\n    k8s.io/kubernetes/cmd/kube-proxy <span class=\"token punctuation\">(</span>static<span class=\"token punctuation\">)</span>\n    k8s.io/kubernetes/cmd/kube-scheduler <span class=\"token punctuation\">(</span>static<span class=\"token punctuation\">)</span>\n    k8s.io/kubernetes/cmd/kubeadm <span class=\"token punctuation\">(</span>static<span class=\"token punctuation\">)</span>\n    k8s.io/kubernetes/cmd/kubectl <span class=\"token punctuation\">(</span>static<span class=\"token punctuation\">)</span>\n    k8s.io/kubernetes/cmd/kubelet <span class=\"token punctuation\">(</span>non-static<span class=\"token punctuation\">)</span>\n+++ <span class=\"token punctuation\">[</span>0508 <span class=\"token number\">15</span>:45:16<span class=\"token punctuation\">]</span> Syncing out of container\n+++ <span class=\"token punctuation\">[</span>0508 <span class=\"token number\">15</span>:45:22<span class=\"token punctuation\">]</span> Building images: linux-arm64\n+++ <span class=\"token punctuation\">[</span>0508 <span class=\"token number\">15</span>:45:22<span class=\"token punctuation\">]</span> Starting <span class=\"token function\">docker</span> build <span class=\"token keyword\">for</span> image: kube-apiserver-arm64\n+++ <span class=\"token punctuation\">[</span>0508 <span class=\"token number\">15</span>:45:22<span class=\"token punctuation\">]</span> Starting <span class=\"token function\">docker</span> build <span class=\"token keyword\">for</span> image: kube-controller-manager-arm64\n+++ <span class=\"token punctuation\">[</span>0508 <span class=\"token number\">15</span>:45:22<span class=\"token punctuation\">]</span> Starting <span class=\"token function\">docker</span> build <span class=\"token keyword\">for</span> image: kube-scheduler-arm64\n+++ <span class=\"token punctuation\">[</span>0508 <span class=\"token number\">15</span>:45:22<span class=\"token punctuation\">]</span> Starting <span class=\"token function\">docker</span> build <span class=\"token keyword\">for</span> image: kube-proxy-arm64\n+++ <span class=\"token punctuation\">[</span>0508 <span class=\"token number\">15</span>:45:22<span class=\"token punctuation\">]</span> Starting <span class=\"token function\">docker</span> build <span class=\"token keyword\">for</span> image: kubectl-arm64\n+++ <span class=\"token punctuation\">[</span>0508 <span class=\"token number\">15</span>:45:32<span class=\"token punctuation\">]</span> Deleting <span class=\"token function\">docker</span> image registry.k8s.io/kubectl-arm64:v1.30.0\n+++ <span class=\"token punctuation\">[</span>0508 <span class=\"token number\">15</span>:45:32<span class=\"token punctuation\">]</span> Deleting <span class=\"token function\">docker</span> image registry.k8s.io/kube-scheduler-arm64:v1.30.0\n+++ <span class=\"token punctuation\">[</span>0508 <span class=\"token number\">15</span>:45:35<span class=\"token punctuation\">]</span> Deleting <span class=\"token function\">docker</span> image registry.k8s.io/kube-proxy-arm64:v1.30.0\n+++ <span class=\"token punctuation\">[</span>0508 <span class=\"token number\">15</span>:45:35<span class=\"token punctuation\">]</span> Deleting <span class=\"token function\">docker</span> image registry.k8s.io/kube-controller-manager-arm64:v1.30.0\n+++ <span class=\"token punctuation\">[</span>0508 <span class=\"token number\">15</span>:45:40<span class=\"token punctuation\">]</span> Deleting <span class=\"token function\">docker</span> image registry.k8s.io/kube-apiserver-arm64:v1.30.0\n+++ <span class=\"token punctuation\">[</span>0508 <span class=\"token number\">15</span>:45:40<span class=\"token punctuation\">]</span> Docker builds <span class=\"token keyword\">done</span>\nFinished building Kubernetes\nBuilding <span class=\"token function\">node</span> image <span class=\"token punctuation\">..</span>.\nBuilding <span class=\"token keyword\">in</span> container: kind-build-1715175957-1495463435\nImage <span class=\"token string\">\"kindest/node:latest\"</span> build completed.</code></pre>\n<p>Now let's build our image with CRI-O on top of <code>kindest/node:latest</code>:</p>\n<div class=\"codetitle codetitle-left\"><b>Dockerfile </b></div>\n<pre class=\"language-dockerfile\" tabindex=\"0\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> kindest/node:latest</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> CRIO_VERSION</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> PROJECT_PATH=prerelease:/<span class=\"token variable\">$CRIO_VERSION</span></span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> echo <span class=\"token string\">\"Installing Packages ...\"</span> <span class=\"token operator\">\\</span>\n    &amp;&amp; apt-get clean <span class=\"token operator\">\\</span>\n    &amp;&amp; apt-get update -y <span class=\"token operator\">\\</span>\n    &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get install -y <span class=\"token operator\">\\</span>\n    software-properties-common vim gnupg <span class=\"token operator\">\\</span>\n    &amp;&amp; echo <span class=\"token string\">\"Installing cri-o ...\"</span> <span class=\"token operator\">\\</span>\n    &amp;&amp; curl -fsSL https://pkgs.k8s.io/addons:/cri-o:/<span class=\"token variable\">$PROJECT_PATH</span>/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/cri-o-apt-keyring.gpg <span class=\"token operator\">\\</span>\n    &amp;&amp; echo <span class=\"token string\">\"deb [signed-by=/etc/apt/keyrings/cri-o-apt-keyring.gpg] https://pkgs.k8s.io/addons:/cri-o:/$PROJECT_PATH/deb/ /\"</span> | tee /etc/apt/sources.list.d/cri-o.list <span class=\"token operator\">\\</span>\n    &amp;&amp; apt-get update <span class=\"token operator\">\\</span>\n    &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get --option=Dpkg::Options::=--force-confdef install -y cri-o <span class=\"token operator\">\\</span>\n    &amp;&amp; sed -i <span class=\"token string\">'s/containerd/crio/g'</span> /etc/crictl.yaml <span class=\"token operator\">\\</span>\n    &amp;&amp; systemctl disable containerd <span class=\"token operator\">\\</span>\n    &amp;&amp; systemctl enable crio</span></code></pre>\n<p>Next let's build image with <a href=\"https://github.com/cri-o/packaging/blob/main/README.md#prereleases\">prerelease:v1.30</a> CRI-O version:</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\">$ <span class=\"token assign-left variable\">CRIO_VERSION</span><span class=\"token operator\">=</span>v1.30\n$ <span class=\"token function\">docker</span> build --build-arg <span class=\"token assign-left variable\">CRIO_VERSION</span><span class=\"token operator\">=</span><span class=\"token variable\">$CRIO_VERSION</span> <span class=\"token parameter variable\">-t</span> kindnode/crio:<span class=\"token variable\">$CRIO_VERSION</span> <span class=\"token builtin class-name\">.</span></code></pre>\n<p>With builded <code>node image</code> we can create the kind cluster:</p>\n<div class=\"codetitle codetitle-left\"><b>kind-crio.yaml </b></div>\n<pre class=\"language-yaml\" tabindex=\"0\"><code class=\"language-yaml\"><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Cluster\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> kind.x<span class=\"token punctuation\">-</span>k8s.io/v1alpha4\n<span class=\"token key atrule\">nodes</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">role</span><span class=\"token punctuation\">:</span> control<span class=\"token punctuation\">-</span>plane\n  <span class=\"token key atrule\">kubeadmConfigPatches</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n    kind: InitConfiguration\n    nodeRegistration:\n      criSocket: unix:///var/run/crio/crio.sock</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n    kind: JoinConfiguration\n    nodeRegistration:\n      criSocket: unix:///var/run/crio/crio.sock</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">role</span><span class=\"token punctuation\">:</span> worker\n  <span class=\"token key atrule\">kubeadmConfigPatches</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n    kind: JoinConfiguration\n    nodeRegistration:\n      criSocket: unix:///var/run/crio/crio.sock</span></code></pre>\n<h3 id=\"create-kind-cluster\" tabindex=\"-1\">Create KIND cluster <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/crio-in-kind/\">#</a></h3>\n<p>Let's create cluster:</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\">$ kind create cluster <span class=\"token parameter variable\">--image</span> kindnode/crio:<span class=\"token variable\">$CRIO_VERSION</span> <span class=\"token parameter variable\">--config</span> ./kind-crio.yaml\nCreating cluster <span class=\"token string\">\"kind\"</span> <span class=\"token punctuation\">..</span>.\n ✓ Ensuring <span class=\"token function\">node</span> image <span class=\"token punctuation\">(</span>kindnode/crio:v1.30<span class=\"token punctuation\">)</span> 🖼\n ✓ Preparing nodes 📦 📦\n ✓ Writing configuration 📜\n ✓ Starting control-plane 🕹️\n ✓ Installing CNI 🔌\n ✓ Installing StorageClass 💾\n ✓ Joining worker nodes 🚜\nSet kubectl context to <span class=\"token string\">\"kind-kind\"</span>\nYou can now use your cluster with:\n\nkubectl cluster-info <span class=\"token parameter variable\">--context</span> kind-kind\n\nHave a question, bug, or feature request? Let us know<span class=\"token operator\">!</span> https://kind.sigs.k8s.io/<span class=\"token comment\">#community 🙂</span></code></pre>\n<h3 id=\"deploy-example\" tabindex=\"-1\">Deploy example <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/crio-in-kind/\">#</a></h3>\n<p>Let's try simple <a href=\"https://github.com/istio/istio/blob/master/samples/httpbin/httpbin.yaml\"><code>kubectl apply -f httpbin.yaml</code></a>:</p>\n<div class=\"codetitle codetitle-left\"><b>httpbin.yaml </b></div>\n<pre class=\"language-yaml\" tabindex=\"0\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ServiceAccount\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> httpbin\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> httpbin\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> httpbin\n    <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> httpbin\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> http\n    <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8000</span>\n    <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> httpbin\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> httpbin\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> httpbin\n      <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> v1\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> httpbin\n        <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> v1\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">serviceAccountName</span><span class=\"token punctuation\">:</span> httpbin\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> docker.io/kong/httpbin\n        <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> IfNotPresent\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> httpbin\n        <span class=\"token comment\"># Same as found in Dockerfile's CMD but using an unprivileged port</span>\n        <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> gunicorn\n        <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span>b\n        <span class=\"token punctuation\">-</span> 0.0.0.0<span class=\"token punctuation\">:</span><span class=\"token number\">8080</span>\n        <span class=\"token punctuation\">-</span> httpbin<span class=\"token punctuation\">:</span>app\n        <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span>k\n        <span class=\"token punctuation\">-</span> gevent\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># Tells pipenv to use a writable directory instead of $HOME</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> WORKON_HOME\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> /tmp\n        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span></code></pre>\n<p>Use <code>port-forward</code>:</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\">$ kubectl port-forward svc/httpbin <span class=\"token number\">8000</span>:8000 <span class=\"token parameter variable\">-n</span> default\n\nForwarding from <span class=\"token number\">127.0</span>.0.1:8000 -<span class=\"token operator\">></span> <span class=\"token number\">8080</span>\nForwarding from <span class=\"token punctuation\">[</span>::1<span class=\"token punctuation\">]</span>:8000 -<span class=\"token operator\">></span> <span class=\"token number\">8080</span></code></pre>\n<p>In another terminal:</p>\n<pre class=\"language-sh\" tabindex=\"0\"><code class=\"language-sh\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> GET localhost:8000/get\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"args\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>, \n  <span class=\"token string\">\"headers\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Accept\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"*/*\"</span>, \n    <span class=\"token string\">\"Host\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"localhost:8000\"</span>, \n    <span class=\"token string\">\"User-Agent\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"curl/8.4.0\"</span>\n  <span class=\"token punctuation\">}</span>, \n  <span class=\"token string\">\"origin\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"127.0.0.1\"</span>, \n  <span class=\"token string\">\"url\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"http://localhost:8000/get\"</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Everything is working like a charm 😄</p>\n<h3 id=\"credits\" tabindex=\"-1\">Credits <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/crio-in-kind/\">#</a></h3>\n<ul>\n<li><small><a href=\"https://gist.github.com/aojea/bd1fb766302779b77b8f68fa0a81c0f2\">How to use CRI-O runtime with KIND</a></small></li>\n<li><small><a href=\"https://kind.sigs.k8s.io/docs/design/node-image/\">node image</a></small></li>\n</ul>\n<p>Happy coding!</p>\n",
			"date_published": "2024-05-08T00:00:00Z"
		}
		,
		{
			"id": "https://rkiselenko.dev/blog/development-on-mac-with-lima/",
			"url": "https://rkiselenko.dev/blog/development-on-mac-with-lima/",
			"title": "Development On Apple Silicon with Lima",
			"content_html": "<div class=\"message-box\">\n<p>\"Lima launches Linux virtual machines with automatic file sharing and port forwarding (similar to WSL2).\" – Lima Website\n</p></div>\n<p><picture><source type=\"image/gif\" srcset=\"https://rkiselenko.dev/img/NDP6WLKe_y-900.gif 900w\"><source type=\"image/avif\" srcset=\"https://rkiselenko.dev/img/NDP6WLKe_y-900.avif 900w\"><source type=\"image/webp\" srcset=\"https://rkiselenko.dev/img/NDP6WLKe_y-900.webp 900w\"><img alt=\"macbook language icon\" loading=\"lazy\" decoding=\"async\" src=\"https://rkiselenko.dev/img/NDP6WLKe_y-900.jpeg\" width=\"900\" height=\"1030\"></picture></p>\n<p>In this article, I'll demonstrate how to provision a Virtual Machine for software development that currently lacks support for Apple silicon. I'll be utilizing <a href=\"https://lima-vm.io/\">Lima VMs</a> to establish development and testing environments specifically tailored for the <a href=\"https://github.com/cri-o/cri-o\">cri-o</a> project.</p>\n<h3 id=\"installation\" tabindex=\"-1\">Installation <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/development-on-mac-with-lima/\">#</a></h3>\n<p>It's better to install <code>Lima</code> with <code>brew</code>, follow the instruction <a href=\"https://lima-vm.io/docs/installation/\">here.</a></p>\n<h3 id=\"create-vm\" tabindex=\"-1\">Create VM <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/development-on-mac-with-lima/\">#</a></h3>\n<p>Next step is create a VM:</p>\n<pre class=\"language-bash\" tabindex=\"0\"><code class=\"language-bash\">limactl create crio\nINFO<span class=\"token punctuation\">[</span>0000<span class=\"token punctuation\">]</span> Creating an instance <span class=\"token string\">\"crio\"</span> from template://default <span class=\"token punctuation\">(</span>Not from template://crio<span class=\"token punctuation\">)</span>\nWARN<span class=\"token punctuation\">[</span>0000<span class=\"token punctuation\">]</span> This form is deprecated. Use <span class=\"token variable\"><span class=\"token variable\">`</span>limactl create <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>crio template://default<span class=\"token variable\">`</span></span> instead\n? Creating an instance <span class=\"token string\">\"crio\"</span>  <span class=\"token punctuation\">[</span>Use arrows to move, <span class=\"token builtin class-name\">type</span> to filter<span class=\"token punctuation\">]</span>\n  Proceed with the current configuration\n<span class=\"token operator\">></span> Open an editor to review or modify the current configuration\n  Choose another template <span class=\"token punctuation\">(</span>docker, podman, archlinux, fedora, <span class=\"token punctuation\">..</span>.<span class=\"token punctuation\">)</span>\n  Exit</code></pre>\n<p>Choose the &quot;Open an editor to review or modify the current configuration&quot; option to review and modify the VM configuration. (Ensure the <code>$EDITOR</code> variable is declared to utilize this option).</p>\n<p>The <code>arch</code> option:</p>\n<pre class=\"language-yaml\" tabindex=\"0\"><code class=\"language-yaml\"><span class=\"token key atrule\">arch</span><span class=\"token punctuation\">:</span> x86_64</code></pre>\n<p>If you choose wrong arch option the following error will be raised:</p>\n<pre class=\"language-bash\" tabindex=\"0\"><code class=\"language-bash\">INFO<span class=\"token punctuation\">[</span>0028<span class=\"token punctuation\">]</span> Starting the instance <span class=\"token string\">\"crio\"</span> with VM driver <span class=\"token string\">\"qemu\"</span>\nINFO<span class=\"token punctuation\">[</span>0028<span class=\"token punctuation\">]</span> QEMU binary <span class=\"token string\">\"/opt/homebrew/bin/qemu-system-aarch64\"</span> seems properly signed with the <span class=\"token string\">\"com.apple.security.hypervisor\"</span> entitlement\nFATA<span class=\"token punctuation\">[</span>0023<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>skipped to download: <span class=\"token string\">\"https://cloud-images.ubuntu.com/releases/23.10/release-20240125/ubuntu-23.10-server-cloudimg-amd64.img\"</span><span class=\"token builtin class-name\">:</span> unsupported arch: <span class=\"token string\">\"x86_64\"</span><span class=\"token punctuation\">]</span></code></pre>\n<p>As you can see from the <code>lima.yaml</code> file, the default template is <code>Ubuntu 23.10</code> on <code>x86_64</code>.</p>\n<p>We'll use unstable artifacts from <a href=\"https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/unstable/xUbuntu_23.10\">the kubic repository</a>.</p>\n<p>Lets mount the directory with project:</p>\n<pre class=\"language-yaml\" tabindex=\"0\"><code class=\"language-yaml\"><span class=\"token key atrule\">mounts</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># Location of cri-o repository</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">location</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"~/Documents/dev/opensource/cri-o\"</span>\n    <span class=\"token key atrule\">writable</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code></pre>\n<p>Next add provision scripts in order to install all needed runtime dependencies:</p>\n<p>Upgrade the instance on boot</p>\n<pre class=\"language-yaml\" tabindex=\"0\"><code class=\"language-yaml\"><span class=\"token key atrule\">upgradePackages</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code></pre>\n<p>The <code>provision</code> option, this part follows the <a href=\"https://github.com/cri-o/cri-o/blob/main/install.md#debian-bullseye-or-higher---ubuntu-2004-or-higher\">install.md</a> guide:</p>\n<pre class=\"language-yaml\" tabindex=\"0\"><code class=\"language-yaml\"><span class=\"token key atrule\">provision</span><span class=\"token punctuation\">:</span>\n<span class=\"token comment\"># `system` is executed with the root privilege</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">mode</span><span class=\"token punctuation\">:</span> system\n  <span class=\"token key atrule\">script</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n    #!/bin/bash\n    # Install deps\n    set -eux -o pipefail\n    export DEBIAN_FRONTEND=noninteractive\n    export OS=xUbuntu_22.04\n    export VERSION=1.24\n    echo \"deb [signed-by=/usr/share/keyrings/libcontainers-archive-keyring.gpg] https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/$OS/ /\" > /etc/apt/sources.list.d/devel:kubic:libcontainers:stable.list\n    echo \"deb [signed-by=/usr/share/keyrings/libcontainers-crio-archive-keyring.gpg] https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/$VERSION/$OS/ /\" > /etc/apt/sources.list.d/devel:kubic:libcontainers:stable:cri-o:$VERSION.list\n    mkdir -p /usr/share/keyrings\n    curl -L https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/$OS/Release.key | gpg --dearmor -o /usr/share/keyrings/libcontainers-archive-keyring.gpg\n    curl -L https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/$VERSION/$OS/Release.key | gpg --dearmor -o /usr/share/keyrings/libcontainers-crio-archive-keyring.gpg\n    apt-get update -qq &amp;&amp; apt-get install -y \\\n      libbtrfs-dev \\\n      containers-common \\\n      git \\\n      bats \\\n      libassuan-dev \\\n      libdevmapper-dev \\\n      libglib2.0-dev \\\n      libc6-dev \\\n      libgpgme-dev \\\n      libgpg-error-dev \\\n      libseccomp-dev \\\n      libsystemd-dev \\\n      libselinux1-dev \\\n      pkg-config \\\n      go-md2man \\\n      cri-o-runc \\\n      libudev-dev \\\n      software-properties-common \\\n      gcc \\\n      make\n    # Install golang\n    wget https://go.dev/dl/go1.21.0.linux-amd64.tar.gz -O go.tar.gz\n    tar -C /usr/local -xzvf go.tar.gz\n    rm -rf go\n    echo 'export GOROOT=/usr/local/go' >> ~/.profile\n    echo 'export GOPATH=$HOME/go' >> ~/.profile\n    echo 'export PATH=$GOPATH/bin:$GOROOT/bin:$PATH' >> ~/.profile</span>\n<span class=\"token comment\"># `user` is executed without the root privilege</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">mode</span><span class=\"token punctuation\">:</span> user\n  <span class=\"token key atrule\">script</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n    #!/bin/bash\n    set -eux -o pipefail\n    echo 'export GOROOT=/usr/local/go' >> ~/.bashrc\n    echo 'export GOPATH=$HOME/go' >> ~/.bashrc\n    echo 'export PATH=$GOPATH/bin:$GOROOT/bin:$PATH' >> ~/.bashrc</span></code></pre>\n<p>Now everything is ready to bootstrat our VM, close editor start the VM:</p>\n<pre class=\"language-bash\" tabindex=\"0\"><code class=\"language-bash\">limactl start crio\nINFO<span class=\"token punctuation\">[</span>0000<span class=\"token punctuation\">]</span> Using the existing instance <span class=\"token string\">\"crio\"</span>\nINFO<span class=\"token punctuation\">[</span>0000<span class=\"token punctuation\">]</span> Starting the instance <span class=\"token string\">\"crio\"</span> with VM driver <span class=\"token string\">\"qemu\"</span>\nINFO<span class=\"token punctuation\">[</span>0000<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>hostagent<span class=\"token punctuation\">]</span> hostagent socket created at /Users/user/.lima/crio/ha.sock\nINFO<span class=\"token punctuation\">[</span>0001<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>hostagent<span class=\"token punctuation\">]</span> Using system firmware <span class=\"token punctuation\">(</span><span class=\"token string\">\"/opt/homebrew/share/qemu/edk2-x86_64-code.fd\"</span><span class=\"token punctuation\">)</span>\nINFO<span class=\"token punctuation\">[</span>0001<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>hostagent<span class=\"token punctuation\">]</span> Starting QEMU <span class=\"token punctuation\">(</span>hint: to <span class=\"token function\">watch</span> the boot progress, see <span class=\"token string\">\"/Users/user/.lima/crio/serial*.log\"</span><span class=\"token punctuation\">)</span>\nINFO<span class=\"token punctuation\">[</span>0001<span class=\"token punctuation\">]</span> SSH Local Port: <span class=\"token number\">52867</span>\nINFO<span class=\"token punctuation\">[</span>0001<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>hostagent<span class=\"token punctuation\">]</span> Waiting <span class=\"token keyword\">for</span> the essential requirement <span class=\"token number\">1</span> of <span class=\"token number\">4</span>: <span class=\"token string\">\"ssh\"</span>\nINFO<span class=\"token punctuation\">[</span>0041<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>hostagent<span class=\"token punctuation\">]</span> Waiting <span class=\"token keyword\">for</span> the essential requirement <span class=\"token number\">1</span> of <span class=\"token number\">4</span>: <span class=\"token string\">\"ssh\"</span>\nINFO<span class=\"token punctuation\">[</span>0051<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>hostagent<span class=\"token punctuation\">]</span> Waiting <span class=\"token keyword\">for</span> the essential requirement <span class=\"token number\">1</span> of <span class=\"token number\">4</span>: <span class=\"token string\">\"ssh\"</span>\nINFO<span class=\"token punctuation\">[</span>0061<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>hostagent<span class=\"token punctuation\">]</span> Waiting <span class=\"token keyword\">for</span> the essential requirement <span class=\"token number\">1</span> of <span class=\"token number\">4</span>: <span class=\"token string\">\"ssh\"</span>\nINFO<span class=\"token punctuation\">[</span>0067<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>hostagent<span class=\"token punctuation\">]</span> The essential requirement <span class=\"token number\">1</span> of <span class=\"token number\">4</span> is satisfied\nINFO<span class=\"token punctuation\">[</span>0067<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>hostagent<span class=\"token punctuation\">]</span> Waiting <span class=\"token keyword\">for</span> the essential requirement <span class=\"token number\">2</span> of <span class=\"token number\">4</span>: <span class=\"token string\">\"user session is ready for ssh\"</span>\nINFO<span class=\"token punctuation\">[</span>0107<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>hostagent<span class=\"token punctuation\">]</span> Waiting <span class=\"token keyword\">for</span> the essential requirement <span class=\"token number\">2</span> of <span class=\"token number\">4</span>: <span class=\"token string\">\"user session is ready for ssh\"</span>\nINFO<span class=\"token punctuation\">[</span>0147<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>hostagent<span class=\"token punctuation\">]</span> Waiting <span class=\"token keyword\">for</span> the essential requirement <span class=\"token number\">2</span> of <span class=\"token number\">4</span>: <span class=\"token string\">\"user session is ready for ssh\"</span>\nINFO<span class=\"token punctuation\">[</span>0188<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>hostagent<span class=\"token punctuation\">]</span> Waiting <span class=\"token keyword\">for</span> the essential requirement <span class=\"token number\">2</span> of <span class=\"token number\">4</span>: <span class=\"token string\">\"user session is ready for ssh\"</span>\nINFO<span class=\"token punctuation\">[</span>0228<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>hostagent<span class=\"token punctuation\">]</span> Waiting <span class=\"token keyword\">for</span> the essential requirement <span class=\"token number\">2</span> of <span class=\"token number\">4</span>: <span class=\"token string\">\"user session is ready for ssh\"</span>\nINFO<span class=\"token punctuation\">[</span>0268<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>hostagent<span class=\"token punctuation\">]</span> Waiting <span class=\"token keyword\">for</span> the essential requirement <span class=\"token number\">2</span> of <span class=\"token number\">4</span>: <span class=\"token string\">\"user session is ready for ssh\"</span></code></pre>\n<p>You can check the logs of VM here:</p>\n<pre class=\"language-bash\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"token function\">tail</span> <span class=\"token parameter variable\">-f</span> /Users/user/.lima/crio/serial.log</code></pre>\n<p>If everything is functioning properly, after starting the VM, executing the <code>limactl shell crio</code> command should open a shell and process the last commands.</p>\n<pre class=\"language-bash\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token parameter variable\">-i</span>\n<span class=\"token function\">git</span> clone https://github.com/containers/conmon\n<span class=\"token builtin class-name\">cd</span> conmon\n<span class=\"token function\">env</span> <span class=\"token string\">\"PATH=<span class=\"token environment constant\">$PATH</span>\"</span> <span class=\"token function\">make</span>\n<span class=\"token function\">env</span> <span class=\"token string\">\"PATH=<span class=\"token environment constant\">$PATH</span>\"</span> <span class=\"token function\">make</span> <span class=\"token function\">install</span>\n<span class=\"token comment\"># Link runc to tests</span>\n<span class=\"token function\">ln</span> <span class=\"token parameter variable\">-s</span> /usr/local/bin/runc /usr/bin/runc</code></pre>\n<p>Lets start some tests:</p>\n<pre class=\"language-bash\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"token comment\"># We need pass PATH variable to the sh shell</span>\n<span class=\"token function\">sudo</span> <span class=\"token parameter variable\">-E</span> <span class=\"token function\">env</span> <span class=\"token string\">\"PATH=<span class=\"token environment constant\">$PATH</span>\"</span> <span class=\"token function\">make</span> testunit</code></pre>\n<p>Tip 🆒</p>\n<p><a href=\"https://github.com/lima-vm/lima/discussions/1890#discussioncomment-7221563\">How to configure <code>lima</code> and <code>VSCode : Remote - SSH</code> plugin.</a></p>\n<p>Happy coding!</p>\n",
			"date_published": "2024-02-12T00:00:00Z"
		}
		,
		{
			"id": "https://rkiselenko.dev/blog/define-validate-generate/",
			"url": "https://rkiselenko.dev/blog/define-validate-generate/",
			"title": "Define, Validate, Generate with CUE language",
			"content_html": "<div class=\"message-box\">\n<p>\"There is nothing so useless as doing efficiently that which should not be done at all.\" – Peter Drucker\n</p></div>\n<p><picture><source type=\"image/gif\" srcset=\"https://rkiselenko.dev/img/cu3HhqDodL-884.gif 884w\"><source type=\"image/avif\" srcset=\"https://rkiselenko.dev/img/cu3HhqDodL-884.avif 884w\"><source type=\"image/webp\" srcset=\"https://rkiselenko.dev/img/cu3HhqDodL-884.webp 884w\"><img alt=\"cue language icon\" loading=\"lazy\" decoding=\"async\" src=\"https://rkiselenko.dev/img/cu3HhqDodL-884.jpeg\" width=\"884\" height=\"850\"></picture></p>\n<p>In this article, I'll briefly explain how to use the <a href=\"https://cuelang.org/\"><code>CUE</code></a> configuration language and how it might help you to keep consistent the <code>YAML</code>/<code>JSON</code> files by validating against the schema, reducing repetition, and many more.</p>\n<blockquote>\n<p><small>Arguably, validation should be the foremost task of any configuration language. Most configuration languages, however, focus on boilerplate removal. CUE is different in that it takes the validation first stance.\n<a href=\"https://cuelang.org/docs/usecases/configuration/\">cuelang.org</a></small></p>\n</blockquote>\n<p>Lets start from a simple example:</p>\n<div class=\"codetitle codetitle-left\"><b>example.cue </b></div>\n<pre class=\"language-cue\" tabindex=\"0\"><code class=\"language-cue\"><span class=\"token comment\">// Schema</span>\n<span class=\"token punctuation\">[</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    name<span class=\"token punctuation\">:</span>  <span class=\"token operator\">*</span><span class=\"token string-literal\"><span class=\"token string\">\"buddy\"</span></span> <span class=\"token operator\">|</span> <span class=\"token builtin\">string</span>\n    count<span class=\"token punctuation\">:</span> <span class=\"token operator\">>=</span><span class=\"token number\">0</span> <span class=\"token operator\">&amp;</span> <span class=\"token operator\">&lt;=</span><span class=\"token number\">100</span> <span class=\"token operator\">|</span> <span class=\"token builtin\">number</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>In the file <code>example.cue</code> we define the <em>schema</em>  and the validation rules of our data.\nThe <em>schema</em> states:</p>\n<ul>\n<li><code>[string]</code> - is an any arbitrary key.</li>\n<li><code>name</code> - default value is <code>&quot;buddy&quot;</code> <em>or</em>  the type is <code>string</code>.</li>\n<li><code>count</code> - default value in between <code>0</code> and <code>100</code> <em>or</em> the type is <code>number</code>.</li>\n</ul>\n<p>That's good, we've the <em>schema</em> of our data, let's check arbitrary <code>YAML</code> against the defined schema.</p>\n<p>Here is an example of <code>YAML</code>, this example contains a bunch of errors related to the wrong value type:</p>\n<div class=\"codetitle codetitle-left\"><b>example.yaml </b></div>\n<pre class=\"language-yaml\" tabindex=\"0\"><code class=\"language-yaml\"><span class=\"token key atrule\">item</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">count</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"110\"</span></code></pre>\n<p>Let's use the <code>cue vet</code> command:</p>\n<pre class=\"language-shell\" tabindex=\"0\"><code class=\"language-shell\">cue vet example.yaml example.cue\nitem.count: <span class=\"token number\">2</span> errors <span class=\"token keyword\">in</span> empty disjunction:\nitem.count: conflicting values <span class=\"token string\">\"110\"</span> and <span class=\"token operator\">>=</span><span class=\"token number\">0</span> <span class=\"token punctuation\">(</span>mismatched types string and number<span class=\"token punctuation\">)</span>:\n    ./example.cue:4:17\n    ./example.cue:6:12\n    ./example.yaml:3:11\nitem.count: conflicting values <span class=\"token string\">\"110\"</span> and number <span class=\"token punctuation\">(</span>mismatched types string and number<span class=\"token punctuation\">)</span>:\n    ./example.cue:4:17\n    ./example.cue:6:26\n    ./example.yaml:3:11\nitem.name: <span class=\"token number\">2</span> errors <span class=\"token keyword\">in</span> empty disjunction:\nitem.name: conflicting values <span class=\"token string\">\"buddy\"</span> and <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span>mismatched types string and list<span class=\"token punctuation\">)</span>:\n    ./example.cue:5:13\n    ./example.yaml:2:10\nitem.name: conflicting values string and <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span>mismatched types string and list<span class=\"token punctuation\">)</span>:\n    ./example.cue:5:23\n    ./example.yaml:2:10</code></pre>\n<p>As you can see there are many errors, is about conflicting values, the <code>name</code> value must be <code>string</code>, and <code>&quot;buddy&quot;</code> is not equal <code>[]</code> and so on.\nLets fix our <code>example.yaml</code></p>\n<div class=\"codetitle codetitle-left\"><b>example.yaml </b></div>\n<pre class=\"language-yaml\" tabindex=\"0\"><code class=\"language-yaml\"><span class=\"token key atrule\">item</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"teammate\"</span>\n  <span class=\"token key atrule\">count</span><span class=\"token punctuation\">:</span> <span class=\"token number\">110</span></code></pre>\n<p>We've changed our <code>example.yaml</code>, run <code>cue vet example.yaml example.cue</code> and there are no errors, but what about the <em>schema</em> state <code>&gt;=0 &amp; &lt;=100 | number</code>?\nThe <em>schema</em> state is right, it denotes the value of the <code>count</code> key must be more or equal <code>0</code> and less or equal <code>100</code> or the <code>number</code> type,\nand in our last changes <code>110</code> is a <code>number</code> type.</p>\n<p>Lets adjunct the <em>schema</em> a little to meet our requirements:</p>\n<div class=\"codetitle codetitle-left\"><b>example.cue </b></div>\n<pre class=\"language-cue\" tabindex=\"0\"><code class=\"language-cue\"><span class=\"token comment\">// Schema</span>\n<span class=\"token punctuation\">[</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    name<span class=\"token punctuation\">:</span>  <span class=\"token operator\">*</span><span class=\"token string-literal\"><span class=\"token string\">\"buddy\"</span></span> <span class=\"token operator\">|</span> <span class=\"token builtin\">string</span>\n    count<span class=\"token punctuation\">:</span> <span class=\"token operator\">>=</span><span class=\"token number\">0</span> <span class=\"token operator\">&amp;</span> <span class=\"token operator\">&lt;=</span><span class=\"token number\">100</span> <span class=\"token operator\">&amp;</span> <span class=\"token builtin\">number</span> <span class=\"token comment\">// instead of '>=0 &amp; &lt;=100 | number'</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Run <code>cue vet</code> again:</p>\n<pre class=\"language-shell\" tabindex=\"0\"><code class=\"language-shell\">cue vet example.yaml example.cue\nitem.count: invalid value <span class=\"token number\">110</span> <span class=\"token punctuation\">(</span>out of bound <span class=\"token operator\">&lt;=</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span>:\n    ./example.cue:6:18\n    ./example.yaml:3:11</code></pre>\n<p>That's right.</p>\n<p>Another things we can do is to move our <em>data</em> closer to <em>schema</em> and generate valid <code>YAML</code>/<code>JSON</code>.</p>\n<p>Let's change <code>example.cue</code> a little:</p>\n<div class=\"codetitle codetitle-left\"><b>example.cue </b></div>\n<pre class=\"language-cue\" tabindex=\"0\"><code class=\"language-cue\"><span class=\"token comment\">// Schema</span>\n<span class=\"token punctuation\">[</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    name<span class=\"token punctuation\">:</span>  <span class=\"token operator\">*</span><span class=\"token string-literal\"><span class=\"token string\">\"buddy\"</span></span> <span class=\"token operator\">|</span> <span class=\"token builtin\">string</span>\n    count<span class=\"token punctuation\">:</span> <span class=\"token operator\">>=</span><span class=\"token number\">0</span> <span class=\"token operator\">&amp;</span> <span class=\"token operator\">&lt;=</span><span class=\"token number\">100</span> <span class=\"token operator\">&amp;</span> <span class=\"token builtin\">number</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// Data</span>\nexample<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n  name<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"somebody\"</span></span>\n  count<span class=\"token punctuation\">:</span> <span class=\"token number\">12</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Now we able to generate a valid <code>YAML</code>/<code>JSON</code> from out data:</p>\n<pre class=\"language-yaml\" tabindex=\"0\"><code class=\"language-yaml\">cue export example.cue <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>out yaml\n<span class=\"token key atrule\">example</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> somebody\n  <span class=\"token key atrule\">count</span><span class=\"token punctuation\">:</span> <span class=\"token number\">12</span></code></pre>\n<pre class=\"language-json\" tabindex=\"0\"><code class=\"language-json\">cue export example.cue --out json\n<span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"example\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"somebody\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"count\"</span><span class=\"token operator\">:</span> <span class=\"token number\">12</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>One of the cool things about <code>CUE</code> here is that it can infer default values for our data from the <em>schema</em>:</p>\n<div class=\"codetitle codetitle-left\"><b>example.cue </b></div>\n<pre class=\"language-cue\" tabindex=\"0\"><code class=\"language-cue\"><span class=\"token comment\">// Schema</span>\n<span class=\"token punctuation\">[</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    name<span class=\"token punctuation\">:</span>  <span class=\"token operator\">*</span><span class=\"token string-literal\"><span class=\"token string\">\"buddy\"</span></span> <span class=\"token operator\">|</span> <span class=\"token builtin\">string</span>\n    count<span class=\"token punctuation\">:</span> <span class=\"token operator\">>=</span><span class=\"token number\">0</span> <span class=\"token operator\">&amp;</span> <span class=\"token operator\">&lt;=</span><span class=\"token number\">100</span> <span class=\"token operator\">&amp;</span> <span class=\"token builtin\">number</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// Data</span>\nexample<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n  count<span class=\"token punctuation\">:</span> <span class=\"token number\">12</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>The code above generate next output:</p>\n<pre class=\"language-yaml\" tabindex=\"0\"><code class=\"language-yaml\">cue export example.cue <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>out yaml\n<span class=\"token key atrule\">example</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> buddy\n  <span class=\"token key atrule\">count</span><span class=\"token punctuation\">:</span> <span class=\"token number\">12</span></code></pre>\n<p>We're working a lot with different types of configurations, and on many occasions,\nthat particular area is a mess, in most cases, the mess happens because of humans,\nsomewhere you chose the wrong type of particular field or just forgot some key, it takes the time from us.\nThere is no more precious thing in the world than time. In my opinion, the <code>CUE</code> can help here.</p>\n<p>In this small article, I've scratched the surface of how <code>CUE</code> works and presented a small example with <em>schema</em> definition and data validation.</p>\n<p>Happy coding!</p>\n",
			"date_published": "2023-10-04T00:00:00Z"
		}
		,
		{
			"id": "https://rkiselenko.dev/blog/grpc-in-golang/",
			"url": "https://rkiselenko.dev/blog/grpc-in-golang/",
			"title": "Organize gRPC and protobuf code in Golang",
			"content_html": "<div class=\"message-box\">\n<p>At this point, it's a simple, effective and fast RPC framework with a lot of cross-language support. If you need something like it, there's not many other choices available with this big of an ecosystem. - Anonymous from HN about gRPC</p>\n</div>\n<p>In this article, I'll describe how to organize protobuf files messages and gRPC services in the <code>Go</code> sources. I'll briefly examine how to use <code>protoc</code> and plugins with the proper imports, and project structure.</p>\n<p>Requirements:</p>\n<ul>\n<li><code>Go</code> &gt;= 1.21</li>\n<li><code>Docker</code>, <code>docker-compose</code></li>\n</ul>\n<p>A diagram describes how the repositories <code>service-a</code>, <code>service-b</code> requires <code>echo-contracts</code>:</p>\n<p><picture><source type=\"image/gif\" srcset=\"https://rkiselenko.dev/img/0UjSCpvtGF-900.gif 900w\"><source type=\"image/avif\" srcset=\"https://rkiselenko.dev/img/0UjSCpvtGF-900.avif 900w\"><source type=\"image/webp\" srcset=\"https://rkiselenko.dev/img/0UjSCpvtGF-900.webp 900w\"><img alt=\"how golang modules organized\" loading=\"lazy\" decoding=\"async\" src=\"https://rkiselenko.dev/img/0UjSCpvtGF-900.png\" width=\"900\" height=\"884\"></picture></p>\n<h2 id=\"jumt-to\" tabindex=\"-1\">Jumt to <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/grpc-in-golang/\">#</a></h2>\n<ul>\n<li><a href=\"https://rkiselenko.dev/blog/grpc-in-golang/\">Structure</a></li>\n<li><a href=\"https://rkiselenko.dev/blog/grpc-in-golang/\">Makefile</a></li>\n<li><a href=\"https://rkiselenko.dev/blog/grpc-in-golang/\">Dockerfile</a></li>\n<li><a href=\"https://rkiselenko.dev/blog/grpc-in-golang/\">docker-compose</a></li>\n<li><a href=\"https://rkiselenko.dev/blog/grpc-in-golang/\">proto options</a></li>\n<li><a href=\"https://rkiselenko.dev/blog/grpc-in-golang/\">generate</a></li>\n<li><a href=\"https://rkiselenko.dev/blog/grpc-in-golang/\">usage</a></li>\n</ul>\n<h3 id=\"project-structure\" tabindex=\"-1\">Project structure <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/grpc-in-golang/\">#</a></h3>\n<p>The repository <code>echo-contracts</code> describes our proto files. It is a <b>standalone</b> <code>Go</code> repository intended to import into other <code>Go</code> sources. Below is a project structure:</p>\n<pre class=\"language-plaintext\" tabindex=\"0\"><code class=\"language-plaintext\">├── Makefile\n├── docker\n│   ├── Dockerfile\n│   └── docker-compose.yaml\n├── go.mod\n├── go.sum\n└── pb\n    ├── message.proto\n    └── service.proto</code></pre>\n<h3 id=\"makefile\" tabindex=\"-1\">Makefile <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/grpc-in-golang/\">#</a></h3>\n<p>The <code>Makefile</code> contains a bunch of valuable targets.</p>\n<div class=\"codetitle codetitle-left\"><b>Makefile </b></div>\n<pre class=\"language-makefile\" tabindex=\"0\"><code class=\"language-makefile\">PROTOC_VERSION <span class=\"token operator\">?=</span> 24.0\n<span class=\"token builtin-target builtin\">.PHONY</span><span class=\"token punctuation\">:</span> help\n<span class=\"token target symbol\">help</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">## Display available commands.</span>\n\t<span class=\"token operator\">@</span>awk <span class=\"token string\">'BEGIN {FS = \":.*?## \"} /^[a-zA-Z_-]+:.*?## / {printf \"\\033[36m%-30s\\033[0m %s\\n\", $$1, $$2}'</span> <span class=\"token variable\">$</span><span class=\"token punctuation\">(</span>MAKEFILE_LIST<span class=\"token punctuation\">)</span>\n\n<span class=\"token builtin-target builtin\">.PHONY</span><span class=\"token punctuation\">:</span> proto-clean\n<span class=\"token target symbol\">proto-clean</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">## Clean generated proto.</span>\n\t<span class=\"token operator\">@</span>rm -rf pb/message\n\t<span class=\"token operator\">@</span>rm -rf pb/service\n\n<span class=\"token builtin-target builtin\">.PHONY</span><span class=\"token punctuation\">:</span> proto-compile\n<span class=\"token target symbol\">proto-compile</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">## Compile message protobuf and gRPC service files.</span>\n\tPLATFORM<span class=\"token operator\">=</span><span class=\"token variable\">$</span><span class=\"token punctuation\">(</span><span class=\"token function\">shell</span> uname -m<span class=\"token punctuation\">)</span> PROTOC_VERSION<span class=\"token operator\">=</span><span class=\"token variable\">$</span><span class=\"token punctuation\">(</span>PROTOC_VERSION<span class=\"token punctuation\">)</span> docker-compose -f docker/docker-compose.yaml run --rm protogen\n\n<span class=\"token builtin-target builtin\">.PHONY</span><span class=\"token punctuation\">:</span> docker-config\n<span class=\"token target symbol\">docker-config</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">## Dump docker-compose configuration.</span>\n\tPLATFORM<span class=\"token operator\">=</span><span class=\"token variable\">$</span><span class=\"token punctuation\">(</span><span class=\"token function\">shell</span> uname -m<span class=\"token punctuation\">)</span> PROTOC_VERSION<span class=\"token operator\">=</span><span class=\"token variable\">$</span><span class=\"token punctuation\">(</span>PROTOC_VERSION<span class=\"token punctuation\">)</span> docker-compose -f docker/docker-compose.yaml config</code></pre>\n<h3 id=\"dockerfile\" tabindex=\"-1\">Dockerfile <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/grpc-in-golang/\">#</a></h3>\n<p>In the <code>Dockerfile</code>, <code>protoc</code> with a particular version is downloaded. The version of <code>protoc</code> binary is declared as <code>PROTOC_VERSION</code> variable at the top of the <code>Makefile</code> and is passed to the docker container during the build stage.</p>\n<p><code>protoc</code> doesn't officially support <code>Go</code> as output, you need to install external plugins.\n<code>gRPC</code> is not the same as <code>Protocol Buffers</code>, <code>gRPC</code> uses <code>Protocol Buffers</code>, hence different plugins are needed to generate <code>Go</code> code messages and services.</p>\n<p>Plugins installed:</p>\n<ul>\n<li><a href=\"https://pkg.go.dev/google.golang.org/grpc/cmd/protoc-gen-go-grpc\">protoc-gen-go-grpc</a> - Generates <code>Go</code> bindings of services in protobuf definition files for <code>gRPC</code>.</li>\n<li><a href=\"https://pkg.go.dev/google.golang.org/protobuf\">protoc-gen-go</a> - A tool to generate <code>Go</code> code for the protocol buffer language, and also the runtime implementation to handle serialization of messages in <code>Go</code>.</li>\n</ul>\n<div class=\"codetitle codetitle-left\"><b>docker/Dockerfile </b></div>\n<pre class=\"language-docker\" tabindex=\"0\"><code class=\"language-docker\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> golang:1.21</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> PLATFORM</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> PROTOC_VERSION</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apt-get update &amp;&amp; apt-get install -y unzip</span>\n\n<span class=\"token comment\"># By default Intel chipset (x86_64) is assumed but if the host device is an Apple</span>\n<span class=\"token comment\"># silicon (arm) chipset based then a relevant (aarch_64) release file is used.</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.31.0</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.3.0</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> export ZIP=x86_64 &amp;&amp; <span class=\"token operator\">\\</span>\n    if [ <span class=\"token variable\">${PLATFORM}</span> = <span class=\"token string\">\"arm64\"</span> ]; then export ZIP=aarch_64; fi &amp;&amp; <span class=\"token operator\">\\</span>\n    wget --quiet https://github.com/protocolbuffers/protobuf/releases/download/v<span class=\"token variable\">${PROTOC_VERSION}</span>/protoc-<span class=\"token variable\">${PROTOC_VERSION}</span>-linux-<span class=\"token variable\">${ZIP}</span>.zip &amp;&amp; <span class=\"token operator\">\\</span>\n    unzip -o protoc-<span class=\"token variable\">${PROTOC_VERSION}</span>-linux-<span class=\"token variable\">${ZIP}</span>.zip -d /usr/local bin/protoc &amp;&amp; <span class=\"token operator\">\\</span>\n    unzip -o protoc-<span class=\"token variable\">${PROTOC_VERSION}</span>-linux-<span class=\"token variable\">${ZIP}</span>.zip -d /usr/local <span class=\"token string\">'include/*'</span></span></code></pre>\n<h3 id=\"docker-compose\" tabindex=\"-1\">docker-compose <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/grpc-in-golang/\">#</a></h3>\n<p>I'm using <code>docker-compose.yaml</code> as an engine for generating <code>proto</code>.</p>\n<div class=\"codetitle codetitle-left\"><b>docker/docker-compose.yaml </b></div>\n<pre class=\"language-yaml\" tabindex=\"0\"><code class=\"language-yaml\"><span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">protogen</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">context</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\".\"</span>\n      <span class=\"token key atrule\">args</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">PLATFORM</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>PLATFORM<span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">PROTOC_VERSION</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>PROTOC_VERSION<span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">working_dir</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/source\"</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"../pb:/source\"</span>\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> bash <span class=\"token punctuation\">-</span>c \"\n        protoc <span class=\"token important\">*.proto</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>proto_path=.\n         <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>go_out=. <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>go_opt=module=github.com/user/echo<span class=\"token punctuation\">-</span>contracts/pb\n         <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>go<span class=\"token punctuation\">-</span>grpc_out=. <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>go<span class=\"token punctuation\">-</span>grpc_opt=module=github.com/user/echo<span class=\"token punctuation\">-</span>contracts/pb\n        \"</code></pre>\n<h3 id=\"proto-options\" tabindex=\"-1\">proto options <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/grpc-in-golang/\">#</a></h3>\n<p>Now we're instructing the <code>protoc</code> to generate code for us, we're planning to import <code>echo-contracts</code> as <code>Go</code> module and we need a proper package structure.</p>\n<p>There is an options for <code>--go_out</code> and <code>--go-grpc_opt</code>:</p>\n<ul>\n<li><code>module=$PREFIX</code> -  the output file is placed in a directory named after the <code>Go</code> package’s import path, but with the specified directory prefix removed from the output filename.</li>\n</ul>\n<p>For example, an input file <code>pb/message.proto</code> with a <code>Go</code> import path of <code>github.com/user/echo-contracts/pb/message</code> and <code>github.com/user/echo-contracts/pb</code> specified as the module prefix results in an output file at <code>pb/message/message.pb.go</code>.</p>\n<p><picture><source type=\"image/gif\" srcset=\"https://rkiselenko.dev/img/thuvX-EMrq-900.gif 900w\"><source type=\"image/avif\" srcset=\"https://rkiselenko.dev/img/thuvX-EMrq-900.avif 900w\"><source type=\"image/webp\" srcset=\"https://rkiselenko.dev/img/thuvX-EMrq-900.webp 900w\"><img alt=\"module option\" loading=\"lazy\" decoding=\"async\" src=\"https://rkiselenko.dev/img/thuvX-EMrq-900.png\" width=\"900\" height=\"514\"></picture></p>\n<p>Here are our <code>proto</code> files:</p>\n<div class=\"codetitle codetitle-left\"><b>pb/message.proto </b></div>\n<pre class=\"language-protobuf\" tabindex=\"0\"><code class=\"language-protobuf\"><span class=\"token keyword\">syntax</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"proto3\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">package</span> echo<span class=\"token punctuation\">.</span><span class=\"token keyword\">service</span><span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">option</span> go_package <span class=\"token operator\">=</span> <span class=\"token string\">\"github.com/user/echo-contracts/pb/message\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">message</span> <span class=\"token class-name\">StringMessage</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">string</span> value <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<div class=\"codetitle codetitle-left\"><b>pb/service.proto </b></div>\n<pre class=\"language-protobuf\" tabindex=\"0\"><code class=\"language-protobuf\"><span class=\"token keyword\">syntax</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"proto3\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">package</span> echo<span class=\"token punctuation\">.</span><span class=\"token keyword\">service</span><span class=\"token punctuation\">.</span>v1<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">option</span> go_package <span class=\"token operator\">=</span> <span class=\"token string\">\"github.com/user/echo-contracts/pb/service\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"message.proto\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">service</span> <span class=\"token class-name\">EchoService</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">rpc</span> <span class=\"token function\">Echo</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StringMessage</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">returns</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">StringMessage</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<div class=\"codetitle codetitle-left\"><b>go.mod </b></div>\n<pre class=\"language-go\" tabindex=\"0\"><code class=\"language-go\">module github<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>user<span class=\"token operator\">/</span>echo<span class=\"token operator\">-</span>contracts\n\n<span class=\"token keyword\">go</span> <span class=\"token number\">1.21</span><span class=\"token number\">.0</span>\n\nrequire <span class=\"token punctuation\">(</span>\n\tgoogle<span class=\"token punctuation\">.</span>golang<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>grpc v1<span class=\"token punctuation\">.</span><span class=\"token number\">57.0</span>\n\tgoogle<span class=\"token punctuation\">.</span>golang<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>protobuf v1<span class=\"token punctuation\">.</span><span class=\"token number\">31.0</span>\n<span class=\"token punctuation\">)</span>\n\nrequire <span class=\"token punctuation\">(</span>\n\tgithub<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>golang<span class=\"token operator\">/</span>protobuf v1<span class=\"token punctuation\">.</span><span class=\"token number\">5.3</span> <span class=\"token comment\">// indirect</span>\n\tgolang<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>x<span class=\"token operator\">/</span>net v0<span class=\"token punctuation\">.</span><span class=\"token number\">9.0</span> <span class=\"token comment\">// indirect</span>\n\tgolang<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>x<span class=\"token operator\">/</span>sys v0<span class=\"token punctuation\">.</span><span class=\"token number\">7.0</span> <span class=\"token comment\">// indirect</span>\n\tgolang<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>x<span class=\"token operator\">/</span>text v0<span class=\"token punctuation\">.</span><span class=\"token number\">9.0</span> <span class=\"token comment\">// indirect</span>\n\tgoogle<span class=\"token punctuation\">.</span>golang<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>genproto<span class=\"token operator\">/</span>googleapis<span class=\"token operator\">/</span>rpc v0<span class=\"token punctuation\">.</span><span class=\"token number\">0.0</span><span class=\"token operator\">-</span><span class=\"token number\">20230525234030</span><span class=\"token operator\">-</span>28d5490b6b19 <span class=\"token comment\">// indirect</span>\n<span class=\"token punctuation\">)</span></code></pre>\n<h3 id=\"generate\" tabindex=\"-1\">generate <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/grpc-in-golang/\">#</a></h3>\n<p>At this step we can generate <code>Go</code> code from proto files. Use the command <code>make proto-compile</code>.\nHere is the directory structure after <code>proto</code> compilation:</p>\n<pre class=\"language-plaintext\" tabindex=\"0\"><code class=\"language-plaintext\">├── Makefile\n├── docker\n│   ├── Dockerfile\n│   └── docker-compose.yaml\n├── go.mod\n├── go.sum\n└── pb\n    ├── message\n    │   └── message.pb.go\n    ├── message.proto\n    ├── service\n    │   ├── service.pb.go\n    │   └── service_grpc.pb.go\n    └── service.proto</code></pre>\n<p>Release <code>echo-contracts</code> <a href=\"https://go.dev/blog/using-go-modules\">Using Go Modules</a>, so it is published as <code>Go</code> module with the proper version.</p>\n<h3 id=\"usage\" tabindex=\"-1\">usage <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/grpc-in-golang/\">#</a></h3>\n<p>To import our <code>echo-contracts</code> <code>Go</code> module, we need to declare it in the <code>main.go</code> file and <code>go.mod</code> as an external dependency:</p>\n<div class=\"codetitle codetitle-left\"><b>main.go </b></div>\n<pre class=\"language-go\" tabindex=\"0\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token comment\">// ...</span>\n\tmessage <span class=\"token string\">\"github.com/user/echo-contracts/pb/message\"</span>\n\tservice <span class=\"token string\">\"github.com/user/echo-contracts/pb/service\"</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// Some code here</span></code></pre>\n<p>And in <code>go.mod</code>:</p>\n<div class=\"codetitle codetitle-left\"><b>go.mod </b></div>\n<pre class=\"language-go\" tabindex=\"0\"><code class=\"language-go\">module service<span class=\"token operator\">-</span>a\n\n<span class=\"token keyword\">go</span> <span class=\"token number\">1.21</span><span class=\"token number\">.0</span>\n\nrequire <span class=\"token punctuation\">(</span>\n  <span class=\"token comment\">// Some imports here</span>\n  github<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>user<span class=\"token operator\">/</span>echo<span class=\"token operator\">-</span>contracts v0<span class=\"token punctuation\">.</span><span class=\"token number\">0.1</span>\n<span class=\"token punctuation\">)</span></code></pre>\n<p>Happy coding!</p>\n",
			"date_published": "2023-08-27T00:00:00Z"
		}
		,
		{
			"id": "https://rkiselenko.dev/blog/resilient-microservice/",
			"url": "https://rkiselenko.dev/blog/resilient-microservice/",
			"title": "Design resilient microservices in Golang",
			"content_html": "<div class=\"message-box\">\n    <p>“Always design a thing by considering it in its next larger context — a chair in a room, a room in a house, a house in an environment, an environment in a city plan” — Eliel Saarinen</p>\n</div>\n<p>If your company, like mine, implements the microservice architecture, it is designed so that one microservice calls another.\nIn case if one service experiencing failure all upstreams of that service receive the same error.\nProblems in one service affect all upstreams, the nightmare of any engineer 🔥.</p>\n<p><picture><source type=\"image/gif\" srcset=\"https://rkiselenko.dev/img/8FbILUyAqn-800.gif 800w\"><source type=\"image/avif\" srcset=\"https://rkiselenko.dev/img/8FbILUyAqn-800.avif 800w\"><source type=\"image/webp\" srcset=\"https://rkiselenko.dev/img/8FbILUyAqn-800.webp 800w\"><img alt=\"an example\" loading=\"lazy\" decoding=\"async\" src=\"https://rkiselenko.dev/img/8FbILUyAqn-800.png\" width=\"800\" height=\"165\"></picture></p>\n<p>Let me explain it with a few simple diagrams. There is the bookstore an application where you can get some information about books, the <code>booksvc</code>, and the <code>storagesvc</code> provide that information.</p>\n<p>The simple diagram below reflect how usually services in a bound context work.</p>\n<p><picture><source type=\"image/gif\" srcset=\"https://rkiselenko.dev/img/wbncPqqBKB-800.gif 800w\"><source type=\"image/avif\" srcset=\"https://rkiselenko.dev/img/wbncPqqBKB-800.avif 800w\"><source type=\"image/webp\" srcset=\"https://rkiselenko.dev/img/wbncPqqBKB-800.webp 800w\"><img alt=\"an example of microservice architecture\" loading=\"lazy\" decoding=\"async\" src=\"https://rkiselenko.dev/img/wbncPqqBKB-800.png\" width=\"800\" height=\"133\"></picture></p>\n<ul>\n<li>Client (any kind of client like web, ios or android application) sends a request, it passthrough <code>booksvc</code> and reaches <code>storagesvc</code>.</li>\n<li>The <code>storagesvc</code> request the database.</li>\n<li><code>storagesvc</code> processes data and returns it to the <code>booksvc</code>.</li>\n</ul>\n<p>Everything is good, so far 😻.</p>\n<p>Now imagine something happens with the database. The database becomes unavailable.\nThat situation is urgent. Our bookstore is unable to provide any service. The client receives errors continuously.</p>\n<p><picture><source type=\"image/gif\" srcset=\"https://rkiselenko.dev/img/X4pPua5IfM-800.gif 800w\"><source type=\"image/avif\" srcset=\"https://rkiselenko.dev/img/X4pPua5IfM-800.avif 800w\"><source type=\"image/webp\" srcset=\"https://rkiselenko.dev/img/X4pPua5IfM-800.webp 800w\"><img alt=\"an example of microservice architecture\" loading=\"lazy\" decoding=\"async\" src=\"https://rkiselenko.dev/img/X4pPua5IfM-800.png\" width=\"800\" height=\"136\"></picture></p>\n<p>A good engineer can predict that kind of situation and use different patterns to avoid things like this.\nI will show you a few patterns, those patterns can be used separately or all together it depends on the particular application requirements.</p>\n<h2 id=\"jump-to\" tabindex=\"-1\">Jump to <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/resilient-microservice/\">#</a></h2>\n<ul>\n<li><a href=\"https://rkiselenko.dev/blog/resilient-microservice/\">Retry</a></li>\n<li><a href=\"https://rkiselenko.dev/blog/resilient-microservice/\">Circuit Breaker</a></li>\n<li><a href=\"https://rkiselenko.dev/blog/resilient-microservice/\">All together</a></li>\n</ul>\n<h2 id=\"code\" tabindex=\"-1\">Code <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/resilient-microservice/\">#</a></h2>\n<p>We need some testing stage, lets create one:</p>\n<ol>\n<li><code>mkdir -p circuitbreaker</code></li>\n<li><code>cd circuitbreaker</code></li>\n<li>create files <code>docker-compose.yaml</code>, <code>Dockerfile.booksvc</code>, <code>Dockerfile.storagesvc</code>, <code>pkg/recache/recache.go</code>, <code>storagesvc.go</code>, <code>go.mod</code></li>\n</ol>\n<div class=\"codetitle codetitle-left\"><b>docker-compose.yaml </b></div>\n<pre class=\"language-yaml\" tabindex=\"0\"><code class=\"language-yaml\"><span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">database</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> postgres<span class=\"token punctuation\">:</span><span class=\"token number\">12.8</span>\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> POSTGRES_USER=pg\n      <span class=\"token punctuation\">-</span> POSTGRES_PASSWORD=pass\n      <span class=\"token punctuation\">-</span> POSTGRES_DB=crud\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> 5432<span class=\"token punctuation\">:</span><span class=\"token number\">5432</span>\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"test_network\"</span>\n  <span class=\"token key atrule\">redis</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'bitnami/redis:latest'</span>\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ALLOW_EMPTY_PASSWORD=yes\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"test_network\"</span>\n  <span class=\"token key atrule\">booksvc</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">context</span><span class=\"token punctuation\">:</span> .\n      <span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> ./Dockerfile.booksvc\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"8081:8081\"</span>\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">REDIS_ADDR</span><span class=\"token punctuation\">:</span> redis<span class=\"token punctuation\">:</span><span class=\"token number\">6379</span>\n      <span class=\"token key atrule\">HTTP_PORT</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\":8081\"</span>\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> redis\n      <span class=\"token punctuation\">-</span> database\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"test_network\"</span>\n  <span class=\"token key atrule\">storagesvc</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">context</span><span class=\"token punctuation\">:</span> .\n      <span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> ./Dockerfile.storagesvc\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">HTTP_PORT</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\":8082\"</span>\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> booksvc\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"test_network\"</span>\n<span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n   <span class=\"token key atrule\">test_network</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">driver</span><span class=\"token punctuation\">:</span> bridge</code></pre>\n<div class=\"codetitle codetitle-left\"><b>Dockerfile.booksvc </b></div>\n<pre class=\"language-dockerfile\" tabindex=\"0\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> golang:1.21</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> mkdir /app</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> . /app</span>\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /app</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> go mod download</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> go build -o booksvc booksvc.go</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">CMD</span> <span class=\"token string\">\"/app/booksvc\"</span></span></code></pre>\n<div class=\"codetitle codetitle-left\"><b>Dockerfile.storagesvc </b></div>\n<pre class=\"language-dockerfile\" tabindex=\"0\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> golang:1.21</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> mkdir /app</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> . /app</span>\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /app</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> go mod download</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> go build -o storagesvc storagesvc.go</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">CMD</span> <span class=\"token string\">\"/app/storagesvc\"</span></span></code></pre>\n<div class=\"codetitle codetitle-left\"><b>pkg/recache/recache.go </b></div>\n<pre class=\"language-go\" tabindex=\"0\"><code class=\"language-go\"><span class=\"token keyword\">package</span> recache\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"time\"</span>\n\n\trds <span class=\"token string\">\"github.com/redis/go-redis/v9\"</span>\n\t<span class=\"token string\">\"golang.org/x/net/context\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">type</span> Redis <span class=\"token keyword\">interface</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">Get</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> key <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token function\">Put</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> key <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> value <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">type</span> service <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n\tc <span class=\"token operator\">*</span>rds<span class=\"token punctuation\">.</span>Client\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">New</span><span class=\"token punctuation\">(</span>options <span class=\"token operator\">*</span>rds<span class=\"token punctuation\">.</span>Options<span class=\"token punctuation\">)</span> Redis <span class=\"token punctuation\">{</span>\n\tredisClient <span class=\"token operator\">:=</span> rds<span class=\"token punctuation\">.</span><span class=\"token function\">NewClient</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token operator\">&amp;</span>service<span class=\"token punctuation\">{</span>c<span class=\"token punctuation\">:</span> redisClient<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">*</span>service<span class=\"token punctuation\">)</span> <span class=\"token function\">Get</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> key <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\tstatus <span class=\"token operator\">:=</span> s<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span><span class=\"token function\">Get</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">.</span><span class=\"token function\">Result</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">*</span>service<span class=\"token punctuation\">)</span> <span class=\"token function\">Put</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> key <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> value <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n\tstatus <span class=\"token operator\">:=</span> s<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">.</span>Minute<span class=\"token operator\">*</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">return</span> status<span class=\"token punctuation\">.</span><span class=\"token function\">Err</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<div class=\"codetitle codetitle-left\"><b>storagesvc.go </b></div>\n<pre class=\"language-go\" tabindex=\"0\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"log\"</span>\n\t<span class=\"token string\">\"log/slog\"</span>\n\t<span class=\"token string\">\"net/http\"</span>\n\t<span class=\"token string\">\"os\"</span>\n\n\t<span class=\"token string\">\"github.com/labstack/echo/v4\"</span>\n\t<span class=\"token string\">\"gorm.io/driver/postgres\"</span>\n\t<span class=\"token string\">\"gorm.io/gorm\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">var</span> <span class=\"token punctuation\">(</span>\n\tlogger <span class=\"token operator\">=</span> slog<span class=\"token punctuation\">.</span><span class=\"token function\">New</span><span class=\"token punctuation\">(</span>slog<span class=\"token punctuation\">.</span><span class=\"token function\">NewJSONHandler</span><span class=\"token punctuation\">(</span>os<span class=\"token punctuation\">.</span>Stdout<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>slog<span class=\"token punctuation\">.</span>HandlerOptions<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">WithAttrs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>slog<span class=\"token punctuation\">.</span>Attr<span class=\"token punctuation\">{</span>slog<span class=\"token punctuation\">.</span><span class=\"token function\">String</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"app\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"storagesvc\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">type</span> book <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n\tId     <span class=\"token builtin\">int</span>    <span class=\"token string\">`json:\"id\" gorm:\"primaryKey\"`</span>\n\tTitle  <span class=\"token builtin\">string</span> <span class=\"token string\">`json:\"title\"`</span>\n\tAuthor <span class=\"token builtin\">string</span> <span class=\"token string\">`json:\"author\"`</span>\n\tDesc   <span class=\"token builtin\">string</span> <span class=\"token string\">`json:\"desc\"`</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token comment\">// Echo instance</span>\n\te <span class=\"token operator\">:=</span> echo<span class=\"token punctuation\">.</span><span class=\"token function\">New</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\tdb<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> gorm<span class=\"token punctuation\">.</span><span class=\"token function\">Open</span><span class=\"token punctuation\">(</span>postgres<span class=\"token punctuation\">.</span><span class=\"token function\">Open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"postgres://pg:pass@database:5432/crud\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>gorm<span class=\"token punctuation\">.</span>Config<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Fatalln</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\n\tdb<span class=\"token punctuation\">.</span><span class=\"token function\">AutoMigrate</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>book<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// Seed database with some data</span>\n\t<span class=\"token keyword\">if</span> result <span class=\"token operator\">:=</span> db<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>book<span class=\"token punctuation\">{</span>Title<span class=\"token punctuation\">:</span> <span class=\"token string\">\"One book\"</span><span class=\"token punctuation\">,</span> Author<span class=\"token punctuation\">:</span> <span class=\"token string\">\"John Doe\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> result<span class=\"token punctuation\">.</span>Error <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlogger<span class=\"token punctuation\">.</span><span class=\"token function\">With</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">.</span>Error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"cant create data\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">if</span> result <span class=\"token operator\">:=</span> db<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>book<span class=\"token punctuation\">{</span>Title<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Second book\"</span><span class=\"token punctuation\">,</span> Author<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Jane Doe\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> result<span class=\"token punctuation\">.</span>Error <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlogger<span class=\"token punctuation\">.</span><span class=\"token function\">With</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">.</span>Error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"cant create data\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token comment\">// Routes</span>\n\te<span class=\"token punctuation\">.</span><span class=\"token function\">GET</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/books\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>c echo<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">var</span> books <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>book\n\t\t<span class=\"token keyword\">if</span> result <span class=\"token operator\">:=</span> db<span class=\"token punctuation\">.</span><span class=\"token function\">Find</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>books<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> result<span class=\"token punctuation\">.</span>Error <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t\tlogger<span class=\"token punctuation\">.</span><span class=\"token function\">With</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">.</span>Error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"cant fetch data\"</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">return</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusInternalServerError<span class=\"token punctuation\">,</span> <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ops, I cant process you request\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\tlogger<span class=\"token punctuation\">.</span><span class=\"token function\">With</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"got books\"</span><span class=\"token punctuation\">,</span> books<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"data fetched\"</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">return</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusOK<span class=\"token punctuation\">,</span> books<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\t<span class=\"token comment\">// Start server</span>\n\te<span class=\"token punctuation\">.</span>Logger<span class=\"token punctuation\">.</span><span class=\"token function\">Fatal</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">Start</span><span class=\"token punctuation\">(</span><span class=\"token string\">\":8082\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<div class=\"codetitle codetitle-left\"><b>go.mod </b></div>\n<pre class=\"language-go\" tabindex=\"0\"><code class=\"language-go\">module example\n\n<span class=\"token keyword\">go</span> <span class=\"token number\">1.21</span>\n\nrequire <span class=\"token punctuation\">(</span>\n\tgithub<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>cenkalti<span class=\"token operator\">/</span>backoff<span class=\"token operator\">/</span>v4 v4<span class=\"token punctuation\">.</span><span class=\"token number\">2.1</span>\n\tgithub<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>labstack<span class=\"token operator\">/</span>echo<span class=\"token operator\">/</span>v4 v4<span class=\"token punctuation\">.</span><span class=\"token number\">10.2</span>\n\tgithub<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>redis<span class=\"token operator\">/</span><span class=\"token keyword\">go</span><span class=\"token operator\">-</span>redis<span class=\"token operator\">/</span>v9 v9<span class=\"token punctuation\">.</span><span class=\"token number\">0.5</span>\n\tgithub<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>sony<span class=\"token operator\">/</span>gobreaker v0<span class=\"token punctuation\">.</span><span class=\"token number\">5.0</span>\n\tgolang<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>x<span class=\"token operator\">/</span>net v0<span class=\"token punctuation\">.</span><span class=\"token number\">9.0</span>\n\tgorm<span class=\"token punctuation\">.</span>io<span class=\"token operator\">/</span>driver<span class=\"token operator\">/</span>postgres v1<span class=\"token punctuation\">.</span><span class=\"token number\">5.2</span>\n\tgorm<span class=\"token punctuation\">.</span>io<span class=\"token operator\">/</span>gorm v1<span class=\"token punctuation\">.</span><span class=\"token number\">25.3</span>\n<span class=\"token punctuation\">)</span>\n\nrequire <span class=\"token punctuation\">(</span>\n\tgithub<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>cespare<span class=\"token operator\">/</span>xxhash<span class=\"token operator\">/</span>v2 v2<span class=\"token punctuation\">.</span><span class=\"token number\">2.0</span> <span class=\"token comment\">// indirect</span>\n\tgithub<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>dgryski<span class=\"token operator\">/</span><span class=\"token keyword\">go</span><span class=\"token operator\">-</span>rendezvous v0<span class=\"token punctuation\">.</span><span class=\"token number\">0.0</span><span class=\"token operator\">-</span><span class=\"token number\">20200823014737</span><span class=\"token operator\">-</span>9f7001d12a5f <span class=\"token comment\">// indirect</span>\n\tgithub<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>jackc<span class=\"token operator\">/</span>pgpassfile v1<span class=\"token punctuation\">.</span><span class=\"token number\">0.0</span> <span class=\"token comment\">// indirect</span>\n\tgithub<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>jackc<span class=\"token operator\">/</span>pgservicefile v0<span class=\"token punctuation\">.</span><span class=\"token number\">0.0</span><span class=\"token operator\">-</span><span class=\"token number\">20221227161230</span><span class=\"token operator\">-</span>091c0ba34f0a <span class=\"token comment\">// indirect</span>\n\tgithub<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>jackc<span class=\"token operator\">/</span>pgx<span class=\"token operator\">/</span>v5 v5<span class=\"token punctuation\">.</span><span class=\"token number\">3.1</span> <span class=\"token comment\">// indirect</span>\n\tgithub<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>jinzhu<span class=\"token operator\">/</span>inflection v1<span class=\"token punctuation\">.</span><span class=\"token number\">0.0</span> <span class=\"token comment\">// indirect</span>\n\tgithub<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>jinzhu<span class=\"token operator\">/</span>now v1<span class=\"token punctuation\">.</span><span class=\"token number\">1.5</span> <span class=\"token comment\">// indirect</span>\n\tgithub<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>labstack<span class=\"token operator\">/</span>gommon v0<span class=\"token punctuation\">.</span><span class=\"token number\">4.0</span> <span class=\"token comment\">// indirect</span>\n\tgithub<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>mattn<span class=\"token operator\">/</span><span class=\"token keyword\">go</span><span class=\"token operator\">-</span>colorable v0<span class=\"token punctuation\">.</span><span class=\"token number\">1.13</span> <span class=\"token comment\">// indirect</span>\n\tgithub<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>mattn<span class=\"token operator\">/</span><span class=\"token keyword\">go</span><span class=\"token operator\">-</span>isatty v0<span class=\"token punctuation\">.</span><span class=\"token number\">0.17</span> <span class=\"token comment\">// indirect</span>\n\tgithub<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>valyala<span class=\"token operator\">/</span>bytebufferpool v1<span class=\"token punctuation\">.</span><span class=\"token number\">0.0</span> <span class=\"token comment\">// indirect</span>\n\tgithub<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>valyala<span class=\"token operator\">/</span>fasttemplate v1<span class=\"token punctuation\">.</span><span class=\"token number\">2.2</span> <span class=\"token comment\">// indirect</span>\n\tgolang<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>x<span class=\"token operator\">/</span>crypto v0<span class=\"token punctuation\">.</span><span class=\"token number\">8.0</span> <span class=\"token comment\">// indirect</span>\n\tgolang<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>x<span class=\"token operator\">/</span>sys v0<span class=\"token punctuation\">.</span><span class=\"token number\">7.0</span> <span class=\"token comment\">// indirect</span>\n\tgolang<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>x<span class=\"token operator\">/</span>text v0<span class=\"token punctuation\">.</span><span class=\"token number\">9.0</span> <span class=\"token comment\">// indirect</span>\n<span class=\"token punctuation\">)</span></code></pre>\n<h2 id=\"retry\" tabindex=\"-1\">Retry <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/resilient-microservice/\">#</a></h2>\n<p>Let's start with a simple one, the <code>Retry</code>.\nWe introduce the <code>Retry</code> logic in our <code>booksvc</code>, so the service will exponentially repeat a request to <code>storagesvc</code> while the client waits.</p>\n<p><picture><source type=\"image/gif\" srcset=\"https://rkiselenko.dev/img/bMj0tdnCNi-800.gif 800w\"><source type=\"image/avif\" srcset=\"https://rkiselenko.dev/img/bMj0tdnCNi-800.avif 800w\"><source type=\"image/webp\" srcset=\"https://rkiselenko.dev/img/bMj0tdnCNi-800.webp 800w\"><img alt=\"An example with exponential retry\" loading=\"lazy\" decoding=\"async\" src=\"https://rkiselenko.dev/img/bMj0tdnCNi-800.png\" width=\"800\" height=\"201\"></picture></p>\n<p>If our database fails to serve queries <code>booksvc</code> will wait and try again and again.</p>\n<div class=\"codetitle codetitle-left\"><b>booksvc.go </b></div>\n<pre class=\"language-go\" tabindex=\"0\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"encoding/json\"</span>\n\t<span class=\"token string\">\"errors\"</span>\n\t<span class=\"token string\">\"io/ioutil\"</span>\n\t<span class=\"token string\">\"log/slog\"</span>\n\t<span class=\"token string\">\"net/http\"</span>\n\t<span class=\"token string\">\"os\"</span>\n\n\t<span class=\"token string\">\"example/pkg/recache\"</span>\n\n\t<span class=\"token punctuation\">.</span> <span class=\"token string\">\"github.com/cenkalti/backoff/v4\"</span>\n\t<span class=\"token string\">\"github.com/labstack/echo/v4\"</span>\n\trds <span class=\"token string\">\"github.com/redis/go-redis/v9\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">var</span> <span class=\"token punctuation\">(</span>\n\tstoragesvc <span class=\"token operator\">=</span> <span class=\"token string\">\"http://storagesvc:8082/books\"</span>\n\tcacheKey   <span class=\"token operator\">=</span> <span class=\"token string\">\"item\"</span>\n\tlogger     <span class=\"token operator\">=</span> slog<span class=\"token punctuation\">.</span><span class=\"token function\">New</span><span class=\"token punctuation\">(</span>\n\t\tslog<span class=\"token punctuation\">.</span><span class=\"token function\">NewJSONHandler</span><span class=\"token punctuation\">(</span>os<span class=\"token punctuation\">.</span>Stdout<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>slog<span class=\"token punctuation\">.</span>HandlerOptions<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">WithAttrs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>slog<span class=\"token punctuation\">.</span>Attr<span class=\"token punctuation\">{</span>slog<span class=\"token punctuation\">.</span><span class=\"token function\">String</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"app\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"booksvc\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">type</span> svc <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n\tstorageSvcPath <span class=\"token builtin\">string</span>\n\tcache          recache<span class=\"token punctuation\">.</span>Redis\n\thttpClient     <span class=\"token operator\">*</span>http<span class=\"token punctuation\">.</span>Client\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// DefaultInitialInterval     = 500 * time.Millisecond</span>\n<span class=\"token comment\">// DefaultRandomizationFactor = 0.5</span>\n<span class=\"token comment\">// DefaultMultiplier          = 1.5</span>\n<span class=\"token comment\">// DefaultMaxInterval         = 60 * time.Second</span>\n<span class=\"token comment\">// DefaultMaxElapsedTime      = 15 * time.Minute</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token comment\">// Echo instance</span>\n\te <span class=\"token operator\">:=</span> echo<span class=\"token punctuation\">.</span><span class=\"token function\">New</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token comment\">// Initialize storage service</span>\n\tstorageSvc <span class=\"token operator\">:=</span> svc<span class=\"token punctuation\">{</span>\n\t\tstorageSvcPath<span class=\"token punctuation\">:</span> storagesvc<span class=\"token punctuation\">,</span>\n\t\thttpClient<span class=\"token punctuation\">:</span>     <span class=\"token operator\">&amp;</span>http<span class=\"token punctuation\">.</span>Client<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\tcache<span class=\"token punctuation\">:</span> recache<span class=\"token punctuation\">.</span><span class=\"token function\">New</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>rds<span class=\"token punctuation\">.</span>Options<span class=\"token punctuation\">{</span>\n\t\t\tAddr<span class=\"token punctuation\">:</span> <span class=\"token string\">\"redis:6379\"</span><span class=\"token punctuation\">,</span>\n\t\t\tDB<span class=\"token punctuation\">:</span>   <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token comment\">// Routes</span>\n\te<span class=\"token punctuation\">.</span><span class=\"token function\">GET</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> storageSvc<span class=\"token punctuation\">.</span>mainHandler<span class=\"token punctuation\">)</span>\n\t<span class=\"token comment\">// Start server</span>\n\te<span class=\"token punctuation\">.</span>Logger<span class=\"token punctuation\">.</span><span class=\"token function\">Fatal</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">Start</span><span class=\"token punctuation\">(</span><span class=\"token string\">\":8081\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Root HTTP Handler of booksvc</span>\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">*</span>svc<span class=\"token punctuation\">)</span> <span class=\"token function\">mainHandler</span><span class=\"token punctuation\">(</span>c echo<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">var</span> <span class=\"token punctuation\">(</span>\n\t\terr   <span class=\"token builtin\">error</span>\n\t\tbooks <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// Operation to retry</span>\n    <span class=\"token comment\">// here we retry our request</span>\n\toperation <span class=\"token operator\">:=</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n\t\tlogger<span class=\"token punctuation\">.</span><span class=\"token function\">Info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"client: get books\"</span><span class=\"token punctuation\">)</span>\n\t\tbooks<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">getBooks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t\tlogger<span class=\"token punctuation\">.</span><span class=\"token function\">With</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"client: error\"</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">return</span> err\n\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span>\n\t<span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// Actual retry call, if at the end retry fail we return an error</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">=</span> <span class=\"token function\">Retry</span><span class=\"token punctuation\">(</span>operation<span class=\"token punctuation\">,</span> <span class=\"token function\">NewExponentialBackOff</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlogger<span class=\"token punctuation\">.</span><span class=\"token function\">With</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"client: error\"</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">return</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusInternalServerError<span class=\"token punctuation\">,</span> <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ops, I cant process you request\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">return</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusOK<span class=\"token punctuation\">,</span> books<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Call storagesvc</span>\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">*</span>svc<span class=\"token punctuation\">)</span> <span class=\"token function\">getBooks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\treq<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">NewRequest</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>MethodGet<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">.</span>storageSvcPath<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> err\n\t<span class=\"token punctuation\">}</span>\n\treq<span class=\"token punctuation\">.</span>Header<span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Content-Type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">)</span>\n\tres<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> s<span class=\"token punctuation\">.</span>httpClient<span class=\"token punctuation\">.</span><span class=\"token function\">Do</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> err\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">if</span> res<span class=\"token punctuation\">.</span>StatusCode <span class=\"token operator\">==</span> http<span class=\"token punctuation\">.</span>StatusInternalServerError <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> errors<span class=\"token punctuation\">.</span><span class=\"token function\">New</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"bad response code\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\tbody<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> ioutil<span class=\"token punctuation\">.</span><span class=\"token function\">ReadAll</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>Body<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">var</span> books <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\tjson<span class=\"token punctuation\">.</span><span class=\"token function\">Unmarshal</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>books<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">return</span> books<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Stop the database container <code>docker stop circutbreaker-database-1</code> and check by querying the <code>booksvc</code> with <code>curl -s http://localhost:8081/</code>. You'll see <code>curl</code> hangs and requests to <code>storagesvc</code> continuously repeated in the logs.</p>\n<h2 id=\"circuit-breaker\" tabindex=\"-1\">Circuit Breaker <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/resilient-microservice/\">#</a></h2>\n<p>Now the <a href=\"https://en.wikipedia.org/wiki/Circuit_breaker_design_pattern\"><code>circuit breaker</code></a>\nThat pattern we'll use with <code>Redis</code> cache, in the <code>booksvc</code>, we add the <code>circuit breaker</code>. Our cache will store the last successful request to <code>storagesvc</code>, and if the <code>circuit breaker</code> persists in an <code>open state</code>, we serve the data from the cache.</p>\n<p><picture><source type=\"image/gif\" srcset=\"https://rkiselenko.dev/img/D9UvZoeyjj-800.gif 800w\"><source type=\"image/avif\" srcset=\"https://rkiselenko.dev/img/D9UvZoeyjj-800.avif 800w\"><source type=\"image/webp\" srcset=\"https://rkiselenko.dev/img/D9UvZoeyjj-800.webp 800w\"><img alt=\"An example with circutbreaker\" loading=\"lazy\" decoding=\"async\" src=\"https://rkiselenko.dev/img/D9UvZoeyjj-800.png\" width=\"800\" height=\"297\"></picture></p>\n<div class=\"codetitle codetitle-left\"><b>booksvc.go </b></div>\n<pre class=\"language-go\" tabindex=\"0\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"context\"</span>\n\t<span class=\"token string\">\"encoding/json\"</span>\n\t<span class=\"token string\">\"errors\"</span>\n\t<span class=\"token string\">\"io/ioutil\"</span>\n\t<span class=\"token string\">\"log/slog\"</span>\n\t<span class=\"token string\">\"net/http\"</span>\n\t<span class=\"token string\">\"os\"</span>\n\t<span class=\"token string\">\"time\"</span>\n\n\t<span class=\"token string\">\"example/pkg/recache\"</span>\n\n\t<span class=\"token string\">\"github.com/labstack/echo/v4\"</span>\n\trds <span class=\"token string\">\"github.com/redis/go-redis/v9\"</span>\n\t<span class=\"token string\">\"github.com/sony/gobreaker\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">var</span> <span class=\"token punctuation\">(</span>\n\tstoragesvc <span class=\"token operator\">=</span> <span class=\"token string\">\"http://storagesvc:8082/books\"</span>\n\tcacheKey   <span class=\"token operator\">=</span> <span class=\"token string\">\"item\"</span>\n\tlogger     <span class=\"token operator\">=</span> slog<span class=\"token punctuation\">.</span><span class=\"token function\">New</span><span class=\"token punctuation\">(</span>\n\t\tslog<span class=\"token punctuation\">.</span><span class=\"token function\">NewTextHandler</span><span class=\"token punctuation\">(</span>os<span class=\"token punctuation\">.</span>Stdout<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>slog<span class=\"token punctuation\">.</span>HandlerOptions<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">WithAttrs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>slog<span class=\"token punctuation\">.</span>Attr<span class=\"token punctuation\">{</span>slog<span class=\"token punctuation\">.</span><span class=\"token function\">String</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"app\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"booksvc\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">)</span>\n\tcb <span class=\"token operator\">*</span>gobreaker<span class=\"token punctuation\">.</span>CircuitBreaker\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">type</span> svc <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n\tstorageSvcPath <span class=\"token builtin\">string</span>\n\tcache          recache<span class=\"token punctuation\">.</span>Redis\n\thttpClient     <span class=\"token operator\">*</span>http<span class=\"token punctuation\">.</span>Client\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">var</span> st gobreaker<span class=\"token punctuation\">.</span>Settings\n\tst<span class=\"token punctuation\">.</span>Name <span class=\"token operator\">=</span> <span class=\"token string\">\"HTTP GET\"</span>\n\tst<span class=\"token punctuation\">.</span>Timeout <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>Second <span class=\"token operator\">*</span> <span class=\"token number\">5</span>\n\tst<span class=\"token punctuation\">.</span>Interval <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>Second <span class=\"token operator\">*</span> <span class=\"token number\">10</span>\n\tst<span class=\"token punctuation\">.</span>ReadyToTrip <span class=\"token operator\">=</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>counts gobreaker<span class=\"token punctuation\">.</span>Counts<span class=\"token punctuation\">)</span> <span class=\"token builtin\">bool</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> counts<span class=\"token punctuation\">.</span>ConsecutiveFailures <span class=\"token operator\">></span> <span class=\"token number\">0</span>\n\t<span class=\"token punctuation\">}</span>\n\n\tcb <span class=\"token operator\">=</span> gobreaker<span class=\"token punctuation\">.</span><span class=\"token function\">NewCircuitBreaker</span><span class=\"token punctuation\">(</span>st<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token comment\">// Echo instance</span>\n\te <span class=\"token operator\">:=</span> echo<span class=\"token punctuation\">.</span><span class=\"token function\">New</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\t<span class=\"token comment\">// Initialize storage service</span>\n\tstorageSvc <span class=\"token operator\">:=</span> svc<span class=\"token punctuation\">{</span>\n\t\tstorageSvcPath<span class=\"token punctuation\">:</span> storagesvc<span class=\"token punctuation\">,</span>\n\t\thttpClient<span class=\"token punctuation\">:</span>     <span class=\"token operator\">&amp;</span>http<span class=\"token punctuation\">.</span>Client<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\tcache<span class=\"token punctuation\">:</span> recache<span class=\"token punctuation\">.</span><span class=\"token function\">New</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>rds<span class=\"token punctuation\">.</span>Options<span class=\"token punctuation\">{</span>\n\t\t\tAddr<span class=\"token punctuation\">:</span> <span class=\"token string\">\"redis:6379\"</span><span class=\"token punctuation\">,</span>\n\t\t\tDB<span class=\"token punctuation\">:</span>   <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token comment\">// Routes</span>\n\te<span class=\"token punctuation\">.</span><span class=\"token function\">GET</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> storageSvc<span class=\"token punctuation\">.</span>mainHandler<span class=\"token punctuation\">)</span>\n\n\t<span class=\"token comment\">// Start server</span>\n\te<span class=\"token punctuation\">.</span>Logger<span class=\"token punctuation\">.</span><span class=\"token function\">Fatal</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">Start</span><span class=\"token punctuation\">(</span><span class=\"token string\">\":8081\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Root HTTP Handler</span>\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">*</span>svc<span class=\"token punctuation\">)</span> <span class=\"token function\">mainHandler</span><span class=\"token punctuation\">(</span>c echo<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">var</span> <span class=\"token punctuation\">(</span>\n\t\terr  <span class=\"token builtin\">error</span>\n\t\tdata <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">)</span>\n\n\tdata<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> cb<span class=\"token punctuation\">.</span><span class=\"token function\">Execute</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span>getBooks<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// If circuit breaker in the open state</span>\n        <span class=\"token comment\">// serve last successful request from out cache</span>\n\t\t<span class=\"token keyword\">if</span> errors<span class=\"token punctuation\">.</span><span class=\"token function\">Is</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">,</span> gobreaker<span class=\"token punctuation\">.</span>ErrOpenState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\titem<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> s<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">.</span><span class=\"token function\">Get</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span><span class=\"token function\">Background</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> cacheKey<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">var</span> m <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\t\t\tjson<span class=\"token punctuation\">.</span><span class=\"token function\">Unmarshal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token function\">byte</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>m<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">return</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusOK<span class=\"token punctuation\">,</span> m<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\tlogger<span class=\"token punctuation\">.</span><span class=\"token function\">With</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"client: error\"</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">return</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusInternalServerError<span class=\"token punctuation\">,</span> <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ops, I cant process you request\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\n\tlogger<span class=\"token punctuation\">.</span><span class=\"token function\">Info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"client: got response\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">return</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusOK<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Storage Service</span>\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">*</span>svc<span class=\"token punctuation\">)</span> <span class=\"token function\">getBooks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\treq<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">NewRequest</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>MethodGet<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">.</span>storageSvcPath<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> err\n\t<span class=\"token punctuation\">}</span>\n\treq<span class=\"token punctuation\">.</span>Header<span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Content-Type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">)</span>\n\n\tres<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> s<span class=\"token punctuation\">.</span>httpClient<span class=\"token punctuation\">.</span><span class=\"token function\">Do</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> err\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">if</span> res<span class=\"token punctuation\">.</span>StatusCode <span class=\"token operator\">==</span> http<span class=\"token punctuation\">.</span>StatusInternalServerError <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> errors<span class=\"token punctuation\">.</span><span class=\"token function\">New</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"bad response code\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\tbody<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> ioutil<span class=\"token punctuation\">.</span><span class=\"token function\">ReadAll</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>Body<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// Put last successfull request to the cache</span>\n\t<span class=\"token keyword\">go</span> s<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">.</span><span class=\"token function\">Put</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span><span class=\"token function\">Background</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> cacheKey<span class=\"token punctuation\">,</span> <span class=\"token function\">string</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n\t<span class=\"token keyword\">var</span> books <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\tjson<span class=\"token punctuation\">.</span><span class=\"token function\">Unmarshal</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>books<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">return</span> books<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Stop the database container <code>docker stop circutbreaker-database-1</code> and check by querying the <code>booksvc</code> with <code>curl -s http://localhost:8081/</code>. Half of the requests to <code>storagesvc</code> fail, and the second half is returned from the cache.</p>\n<h2 id=\"all-things-together\" tabindex=\"-1\">All things together <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/resilient-microservice/\">#</a></h2>\n<p>The last one is <code>Retry</code> with the <code>circuit breaker</code> in this case, our client shouldn't receive any errors and <code>circuit breaker</code> prevents retry from spamming our <code>storagesvc</code> continuously.</p>\n<p><picture><source type=\"image/gif\" srcset=\"https://rkiselenko.dev/img/AhmuUs3UmU-800.gif 800w\"><source type=\"image/avif\" srcset=\"https://rkiselenko.dev/img/AhmuUs3UmU-800.avif 800w\"><source type=\"image/webp\" srcset=\"https://rkiselenko.dev/img/AhmuUs3UmU-800.webp 800w\"><img alt=\"An example with circutbreaker\" loading=\"lazy\" decoding=\"async\" src=\"https://rkiselenko.dev/img/AhmuUs3UmU-800.png\" width=\"800\" height=\"181\"></picture></p>\n<div class=\"codetitle codetitle-left\"><b>booksvc.go </b></div>\n<pre class=\"language-go\" tabindex=\"0\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"context\"</span>\n\t<span class=\"token string\">\"encoding/json\"</span>\n\t<span class=\"token string\">\"errors\"</span>\n\t<span class=\"token string\">\"io/ioutil\"</span>\n\t<span class=\"token string\">\"log/slog\"</span>\n\t<span class=\"token string\">\"net/http\"</span>\n\t<span class=\"token string\">\"os\"</span>\n\t<span class=\"token string\">\"time\"</span>\n\n\t<span class=\"token string\">\"example/pkg/recache\"</span>\n\n\t<span class=\"token punctuation\">.</span> <span class=\"token string\">\"github.com/cenkalti/backoff/v4\"</span>\n\t<span class=\"token string\">\"github.com/labstack/echo/v4\"</span>\n\trds <span class=\"token string\">\"github.com/redis/go-redis/v9\"</span>\n\t<span class=\"token string\">\"github.com/sony/gobreaker\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">var</span> <span class=\"token punctuation\">(</span>\n\tstoragesvc <span class=\"token operator\">=</span> <span class=\"token string\">\"http://storagesvc:8082/books\"</span>\n\tcacheKey   <span class=\"token operator\">=</span> <span class=\"token string\">\"item\"</span>\n\tlogger     <span class=\"token operator\">=</span> slog<span class=\"token punctuation\">.</span><span class=\"token function\">New</span><span class=\"token punctuation\">(</span>\n\t\tslog<span class=\"token punctuation\">.</span><span class=\"token function\">NewTextHandler</span><span class=\"token punctuation\">(</span>os<span class=\"token punctuation\">.</span>Stdout<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>slog<span class=\"token punctuation\">.</span>HandlerOptions<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">WithAttrs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>slog<span class=\"token punctuation\">.</span>Attr<span class=\"token punctuation\">{</span>slog<span class=\"token punctuation\">.</span><span class=\"token function\">String</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"app\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"booksvc\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">)</span>\n\tcb             <span class=\"token operator\">*</span>gobreaker<span class=\"token punctuation\">.</span>CircuitBreaker\n\tbadResponseErr <span class=\"token operator\">=</span> errors<span class=\"token punctuation\">.</span><span class=\"token function\">New</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"bad response code\"</span><span class=\"token punctuation\">)</span>\n\tmaxRetries     <span class=\"token operator\">=</span> <span class=\"token function\">uint64</span><span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">type</span> svc <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n\tstorageSvcPath <span class=\"token builtin\">string</span>\n\tcache          recache<span class=\"token punctuation\">.</span>Redis\n\thttpClient     <span class=\"token operator\">*</span>http<span class=\"token punctuation\">.</span>Client\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">var</span> st gobreaker<span class=\"token punctuation\">.</span>Settings\n\tst<span class=\"token punctuation\">.</span>Name <span class=\"token operator\">=</span> <span class=\"token string\">\"HTTP GET\"</span>\n\tst<span class=\"token punctuation\">.</span>Timeout <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>Second <span class=\"token operator\">*</span> <span class=\"token number\">5</span>\n\tst<span class=\"token punctuation\">.</span>Interval <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>Second <span class=\"token operator\">*</span> <span class=\"token number\">10</span>\n\tst<span class=\"token punctuation\">.</span>ReadyToTrip <span class=\"token operator\">=</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>counts gobreaker<span class=\"token punctuation\">.</span>Counts<span class=\"token punctuation\">)</span> <span class=\"token builtin\">bool</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> counts<span class=\"token punctuation\">.</span>ConsecutiveFailures <span class=\"token operator\">></span> <span class=\"token number\">0</span>\n\t<span class=\"token punctuation\">}</span>\n\n\tcb <span class=\"token operator\">=</span> gobreaker<span class=\"token punctuation\">.</span><span class=\"token function\">NewCircuitBreaker</span><span class=\"token punctuation\">(</span>st<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token comment\">// Echo instance</span>\n\te <span class=\"token operator\">:=</span> echo<span class=\"token punctuation\">.</span><span class=\"token function\">New</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\t<span class=\"token comment\">// Initialize storage service</span>\n\tstorageSvc <span class=\"token operator\">:=</span> svc<span class=\"token punctuation\">{</span>\n\t\tstorageSvcPath<span class=\"token punctuation\">:</span> storagesvc<span class=\"token punctuation\">,</span>\n\t\thttpClient<span class=\"token punctuation\">:</span>     <span class=\"token operator\">&amp;</span>http<span class=\"token punctuation\">.</span>Client<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\tcache<span class=\"token punctuation\">:</span> recache<span class=\"token punctuation\">.</span><span class=\"token function\">New</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>rds<span class=\"token punctuation\">.</span>Options<span class=\"token punctuation\">{</span>\n\t\t\tAddr<span class=\"token punctuation\">:</span> <span class=\"token string\">\"redis:6379\"</span><span class=\"token punctuation\">,</span>\n\t\t\tDB<span class=\"token punctuation\">:</span>   <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token comment\">// Routes</span>\n\te<span class=\"token punctuation\">.</span><span class=\"token function\">GET</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> storageSvc<span class=\"token punctuation\">.</span>mainHandler<span class=\"token punctuation\">)</span>\n\n\t<span class=\"token comment\">// Start server</span>\n\te<span class=\"token punctuation\">.</span>Logger<span class=\"token punctuation\">.</span><span class=\"token function\">Fatal</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">Start</span><span class=\"token punctuation\">(</span><span class=\"token string\">\":8081\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Root HTTP Handler</span>\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">*</span>svc<span class=\"token punctuation\">)</span> <span class=\"token function\">mainHandler</span><span class=\"token punctuation\">(</span>c echo<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">var</span> <span class=\"token punctuation\">(</span>\n\t\terr  <span class=\"token builtin\">error</span>\n\t\tdata <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">)</span>\n\n\t<span class=\"token comment\">// Operation to retry</span>\n\toperation <span class=\"token operator\">:=</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n\t\tdata<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> cb<span class=\"token punctuation\">.</span><span class=\"token function\">Execute</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span>getBooks<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t\tlogger<span class=\"token punctuation\">.</span><span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"client: error\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">return</span> err\n\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> <span class=\"token function\">Retry</span><span class=\"token punctuation\">(</span>operation<span class=\"token punctuation\">,</span> <span class=\"token function\">WithMaxRetries</span><span class=\"token punctuation\">(</span><span class=\"token function\">NewExponentialBackOff</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> maxRetries<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token comment\">// If max retry count exceed we get data from cache</span>\n\t\titem<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> s<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">.</span><span class=\"token function\">Get</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span><span class=\"token function\">Background</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> cacheKey<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">var</span> m <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\t\tjson<span class=\"token punctuation\">.</span><span class=\"token function\">Unmarshal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token function\">byte</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>m<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">return</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusOK<span class=\"token punctuation\">,</span> m<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">if</span> data <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusOK<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">return</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">JSON</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusInternalServerError<span class=\"token punctuation\">,</span> <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ops, I cant process you request\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Storage Service</span>\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">*</span>svc<span class=\"token punctuation\">)</span> <span class=\"token function\">getBooks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\treq<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">NewRequest</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>MethodGet<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">.</span>storageSvcPath<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> err\n\t<span class=\"token punctuation\">}</span>\n\treq<span class=\"token punctuation\">.</span>Header<span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Content-Type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">)</span>\n\n\tres<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> s<span class=\"token punctuation\">.</span>httpClient<span class=\"token punctuation\">.</span><span class=\"token function\">Do</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> err\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">if</span> res<span class=\"token punctuation\">.</span>StatusCode <span class=\"token operator\">==</span> http<span class=\"token punctuation\">.</span>StatusInternalServerError <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> badResponseErr\n\t<span class=\"token punctuation\">}</span>\n\tbody<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> ioutil<span class=\"token punctuation\">.</span><span class=\"token function\">ReadAll</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>Body<span class=\"token punctuation\">)</span>\n\n\t<span class=\"token keyword\">go</span> s<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">.</span><span class=\"token function\">Put</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span><span class=\"token function\">Background</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> cacheKey<span class=\"token punctuation\">,</span> <span class=\"token function\">string</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n\t<span class=\"token keyword\">var</span> books <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\tjson<span class=\"token punctuation\">.</span><span class=\"token function\">Unmarshal</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>books<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">return</span> books<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Stop the database container <code>docker stop circutbreaker-database-1</code> and check by querying the <code>booksvc</code> with <code>curl -s http://localhost:8081/</code>. The request will probably hang for a while but it soon returns a cached response and it shouldn't return any errors in all next requests.</p>\n<h2 id=\"conclusion\" tabindex=\"-1\">Conclusion <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/resilient-microservice/\">#</a></h2>\n<p>The patterns I've described help you design and implement resilient microservice and limit the impact of service failures and latencies. That code must be used with proper alerting so you can understand fastly what goes wrong and fix it.</p>\n<h3 id=\"credits\" tabindex=\"-1\">Credits <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/resilient-microservice/\">#</a></h3>\n<ul>\n<li><small><a href=\"https://github.com/cenkalti/backoff\">backoff - The exponential backoff algorithm in Go</a></small></li>\n<li><small><a href=\"https://github.com/sony/gobreaker\">gobreaker - Circuit Breaker implemented in Go</a></small></li>\n<li><small>This article is a Golang version of <a href=\"https://sylhare.github.io/2022/12/16/Cache-retry-or-break.html\"><code>Cache , retry or break</code></a> with some changes.</small></li>\n</ul>\n<p>Happy coding!</p>\n",
			"date_published": "2023-08-14T00:00:00Z"
		}
		,
		{
			"id": "https://rkiselenko.dev/blog/dockertest/",
			"url": "https://rkiselenko.dev/blog/dockertest/",
			"title": "Write integration tests with dockertest in Golang",
			"content_html": "<div class=\"message-box\">\n “Tests are stories we tell the next generation of programmers on a project.”\n<p>― Roy Osherove</p>\n</div>\n<p>Integration tests are the most effective way to test your application.\nThe developers themselves usually write those tests.\nThis tutorial aims to show you how easy and efficient it is to write integration tests with <a href=\"https://github.com/ory/dockertest\">dockertest</a>.</p>\n<h2 id=\"appication\" tabindex=\"-1\">Appication <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/dockertest/\">#</a></h2>\n<p>First, let's describe the tools we'll use:</p>\n<ul>\n<li><a href=\"https://gin-gonic.com/\">gin</a> - HTTP web framework.</li>\n<li><a href=\"https://redis.io/\">redis</a> - Key/Value storage</li>\n<li><a href=\"https://docs.docker.com/compose/\">docker-compose</a> - A tool for defining and running multi-container Docker applications.</li>\n<li><a href=\"https://onsi.github.io/ginkgo/#getting-started\">ginkgo</a> - Testing Framework for Go</li>\n<li><a href=\"https://github.com/ory/dockertest\">dockertest</a> - Dockertest helps you boot up ephermal docker images for your Go tests with minimal work.</li>\n</ul>\n<p>Next, let's describe the application; as an example, we'll use a simple application with REST API.\nOur API exposes three endpoints:</p>\n<ul>\n<li><code>GET /health</code> - check if application ready to accept requests.</li>\n<li><code>GET /item</code> - get item from the storage.</li>\n<li><code>POST /item</code> - put item to storage.</li>\n</ul>\n<p>The item we will put to the <code>Redis</code> contains an expire timeout set to 10 seconds.</p>\n<p>The application logic is simple: an external client puts an item into the service, and another client gets the thing.</p>\n<h2 id=\"structure\" tabindex=\"-1\">Structure <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/dockertest/\">#</a></h2>\n<p>Usually, we’re using  Docker Compose as our development environment. The config contains all our docker image tags and parameters.\nThe command to build and run the application: <code>docker-compose up --build</code>.\nHere is the <code>docker-compose.yml</code> file for our application:</p>\n<pre class=\"language-yml\" tabindex=\"0\"><code class=\"language-yml\"><span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">redis</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'bitnami/redis:latest'</span>\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ALLOW_EMPTY_PASSWORD=yes\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"test_network\"</span>\n  <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span> .\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"8080:8080\"</span>\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">REDIS_ADDR</span><span class=\"token punctuation\">:</span> redis<span class=\"token punctuation\">:</span><span class=\"token number\">6379</span>\n      <span class=\"token key atrule\">HTTP_PORT</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\":8080\"</span>\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> redis\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"test_network\"</span>\n<span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n   <span class=\"token key atrule\">test_network</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">driver</span><span class=\"token punctuation\">:</span> bridge</code></pre>\n<p>The structure:</p>\n<pre class=\"language-bash\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"token operator\">></span> tree\n├── Dockerfile\n├── bin\n│   └── server\n├── cmd\n│   ├── config.go <span class=\"token comment\"># config struct for parsing ENV variables</span>\n│   ├── main.go\n│   └── server.go <span class=\"token comment\"># holds handlers for out REST API</span>\n├── docker-compose.yml\n├── go.mod\n├── go.sum\n├── integration_tests\n│   ├── <span class=\"token function\">service</span>\n│   │   └── service.go <span class=\"token comment\"># dockertest logic to spinup containers</span>\n│   └── suite_test.go  <span class=\"token comment\"># ginkgo specs to tests our application</span>\n└── pkg\n    └── recache\n        └── recache.go <span class=\"token comment\"># redis client</span>\n\n<span class=\"token number\">7</span> directories, <span class=\"token number\">12</span> files</code></pre>\n<h2 id=\"tests\" tabindex=\"-1\">Tests <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/dockertest/\">#</a></h2>\n<p>Our tests cases would cover next steps:</p>\n<ul>\n<li>Put item to redis by calling <code>POST /item</code> with json payload like this for example <code>{&quot;counter&quot;: 15}</code>.</li>\n<li>Get item from redis by calling <code>GET /item</code> and expect json response like  <code>{&quot;counter&quot;: 15}</code>.</li>\n<li>Wait 15 seconds and call <code>GET /item</code> again and expect an error.</li>\n</ul>\n<p>Our tests are placed in the <code>integration_tests</code> folder.</p>\n<p>There is <code>integration_tests/service</code> package holds the logic to spin up docker containers for our application in the same way as we're using it in our <code>docker-compose.yml</code>.</p>\n<p>Here is the code from <code>integration_tests/service</code> package:</p>\n<pre class=\"language-go\" tabindex=\"0\"><code class=\"language-go\"><span class=\"token comment\">// This struct holds services</span>\n<span class=\"token comment\">// 1. The application container built from Dockerfile</span>\n<span class=\"token comment\">// 2. The redis container build from bitnami/redis image</span>\n<span class=\"token keyword\">type</span> Service <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n\tContainer <span class=\"token operator\">*</span>dockertest<span class=\"token punctuation\">.</span>Resource\n\tRedis     <span class=\"token operator\">*</span>dockertest<span class=\"token punctuation\">.</span>Resource\n\tNetwork   <span class=\"token operator\">*</span>dockertest<span class=\"token punctuation\">.</span>Network\n\tPool      <span class=\"token operator\">*</span>dockertest<span class=\"token punctuation\">.</span>Pool\n<span class=\"token punctuation\">}</span></code></pre>\n<p>The <code>New</code> function we're using in our <code>suite_test.go</code>, follow comments in the code:</p>\n<pre class=\"language-go\" tabindex=\"0\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">New</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>Service<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Initialize docker pool</span>\n    <span class=\"token comment\">// This command create a pool to interact with docker runtime</span>\n    <span class=\"token comment\">// I'm using colima but Docker Desktop also should work.</span>\n\tpool<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> dockertest<span class=\"token punctuation\">.</span><span class=\"token function\">NewPool</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Could not construct pool: %s\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> err\n\t<span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Ping the docker daemon</span>\n    <span class=\"token comment\">// check if everything is good and</span>\n    <span class=\"token comment\">// there is the connection with docker</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">=</span> pool<span class=\"token punctuation\">.</span>Client<span class=\"token punctuation\">.</span><span class=\"token function\">Ping</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">`could not connect to docker: %s`</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> err\n\t<span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Create a network for our containers</span>\n\tnetwork<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> pool<span class=\"token punctuation\">.</span><span class=\"token function\">CreateNetwork</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test_network\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">`could not connect to docker: %s`</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> err\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token comment\">// Build and run the redis server</span>\n\tredisContainer<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> pool<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"bitnami/redis\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"latest\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"ALLOW_EMPTY_PASSWORD=yes\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">`could not start redis: %s`</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> err\n\t<span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Connect redis container to our network </span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> redisContainer<span class=\"token punctuation\">.</span><span class=\"token function\">ConnectToNetwork</span><span class=\"token punctuation\">(</span>network<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">`could not connect to network: %s`</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> err\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token comment\">// retry check redis connection</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">=</span> pool<span class=\"token punctuation\">.</span><span class=\"token function\">Retry</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">var</span> db <span class=\"token operator\">*</span>redis<span class=\"token punctuation\">.</span>Client\n        <span class=\"token comment\">// Here we are connecting to the redis server and ping that server</span>\n\t\t<span class=\"token comment\">// It's matter to note the address, since we're out of the docker network</span>\n\t\t<span class=\"token comment\">// We can use `localhost`, but in the our application container we can't use `localhost`</span>\n\t\tdb <span class=\"token operator\">=</span> redis<span class=\"token punctuation\">.</span><span class=\"token function\">NewClient</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>redis<span class=\"token punctuation\">.</span>Options<span class=\"token punctuation\">{</span>\n\t\t\tAddr<span class=\"token punctuation\">:</span> fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Sprintf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"localhost:%s\"</span><span class=\"token punctuation\">,</span> redisContainer<span class=\"token punctuation\">.</span><span class=\"token function\">GetPort</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"6379/tcp\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t\terr <span class=\"token operator\">:=</span> db<span class=\"token punctuation\">.</span><span class=\"token function\">Ping</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Err</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"health check error: %s\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">return</span> err\n\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Could not connect pass redis check: %s\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> err\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token comment\">// Build and run the given Dockerfile</span>\n\tresource<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> pool<span class=\"token punctuation\">.</span><span class=\"token function\">BuildAndRunWithOptions</span><span class=\"token punctuation\">(</span>\n\t\t<span class=\"token string\">\"../Dockerfile\"</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token operator\">&amp;</span>dockertest<span class=\"token punctuation\">.</span>RunOptions<span class=\"token punctuation\">{</span>\n\t\t\tHostname<span class=\"token punctuation\">:</span>  <span class=\"token string\">\"server\"</span><span class=\"token punctuation\">,</span>\n\t\t\tNetworkID<span class=\"token punctuation\">:</span> network<span class=\"token punctuation\">.</span>Network<span class=\"token punctuation\">.</span>ID<span class=\"token punctuation\">,</span>\n\t\t\tName<span class=\"token punctuation\">:</span>      <span class=\"token string\">\"test-application\"</span><span class=\"token punctuation\">,</span>\n\t\t\tPortBindings<span class=\"token punctuation\">:</span> <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span>docker<span class=\"token punctuation\">.</span>Port<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>docker<span class=\"token punctuation\">.</span>PortBinding<span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token string\">\"8080/tcp\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>docker<span class=\"token punctuation\">.</span>PortBinding<span class=\"token punctuation\">{</span> <span class=\"token punctuation\">{</span> HostPort<span class=\"token punctuation\">:</span> <span class=\"token string\">\"8080\"</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\t\tEnv<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// Here is we get the actuall IP of redis container in our docker network</span>\n\t\t\t\t<span class=\"token comment\">// The address is different from localhost</span>\n\t\t\t\t<span class=\"token string\">\"REDIS_ADDR=\"</span> <span class=\"token operator\">+</span> fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Sprintf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s:6379\"</span><span class=\"token punctuation\">,</span> redisContainer<span class=\"token punctuation\">.</span><span class=\"token function\">GetIPInNetwork</span><span class=\"token punctuation\">(</span>network<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\t\t<span class=\"token string\">\"HTTP_PORT=:8080\"</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Could not start resource: %s\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> err\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token comment\">// Retry /health endpoint</span>\n\t<span class=\"token comment\">// and check if our application container is ready to accept requests</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">=</span> pool<span class=\"token punctuation\">.</span><span class=\"token function\">Retry</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n\t\terr <span class=\"token operator\">:=</span> <span class=\"token function\">checkHealth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"health check error: %s\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">return</span> err\n\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Could not pass health: %s\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> err\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token operator\">&amp;</span>Service<span class=\"token punctuation\">{</span>resource<span class=\"token punctuation\">,</span> redisContainer<span class=\"token punctuation\">,</span> network<span class=\"token punctuation\">,</span> pool<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>The code above does all the routine to build and run our application by using <code>Dockerfile</code>.\nThere is a useful function for HTTP calls and <code>Close()</code> function which cleanup our resources by removing the network and purging containers.</p>\n<p>Here is the code from <code>integration_tests/suite_tests.go</code>:</p>\n<pre class=\"language-go\" tabindex=\"0\"><code class=\"language-go\"><span class=\"token keyword\">var</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">=</span> <span class=\"token function\">Describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"IntegrationTests\"</span><span class=\"token punctuation\">,</span> Ordered<span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">var</span> <span class=\"token punctuation\">(</span>\n\t\tsrv     <span class=\"token operator\">*</span>service<span class=\"token punctuation\">.</span>Service\n\t\terr     <span class=\"token builtin\">error</span>\n\t\tcounter <span class=\"token builtin\">float64</span>\n\t<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// Initialize our docker containers</span>\n    <span class=\"token comment\">// Pass all health checks</span>\n    <span class=\"token comment\">// Expect no errors</span>\n\t<span class=\"token function\">BeforeAll</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tsrv<span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> service<span class=\"token punctuation\">.</span><span class=\"token function\">New</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\tcounter <span class=\"token operator\">=</span> <span class=\"token function\">float64</span><span class=\"token punctuation\">(</span><span class=\"token number\">15</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token function\">Expect</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">To</span><span class=\"token punctuation\">(</span><span class=\"token function\">BeNil</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token function\">Expect</span><span class=\"token punctuation\">(</span>srv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">NotTo</span><span class=\"token punctuation\">(</span><span class=\"token function\">BeNil</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// Cleanup our resoursec after all steps</span>\n\t<span class=\"token function\">AfterAll</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\terr <span class=\"token operator\">=</span> srv<span class=\"token punctuation\">.</span><span class=\"token function\">Close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token function\">Expect</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">To</span><span class=\"token punctuation\">(</span><span class=\"token function\">BeNil</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\t<span class=\"token function\">Describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"put item to redis\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token function\">Context</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"send POST request\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token function\">It</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"should be a 200 OK response\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\tbody <span class=\"token operator\">:=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token function\">byte</span><span class=\"token punctuation\">(</span>fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Sprintf</span><span class=\"token punctuation\">(</span><span class=\"token string\">`{ \"counter\": %v }`</span><span class=\"token punctuation\">,</span> counter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token comment\">// Use `localhost:8080` since we're outside of docker network</span>\n\t\t\t\tresponse<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> service<span class=\"token punctuation\">.</span><span class=\"token function\">PostRequst</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http://localhost:8080/item\"</span><span class=\"token punctuation\">,</span> body<span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token function\">Expect</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">To</span><span class=\"token punctuation\">(</span><span class=\"token function\">BeNil</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token function\">Expect</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">To</span><span class=\"token punctuation\">(</span><span class=\"token function\">Equal</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"success\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\t<span class=\"token function\">Describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"get item from redis\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token function\">Context</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"send GET request\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token function\">It</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"should be a 200 OK response\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\tresponse<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> service<span class=\"token punctuation\">.</span><span class=\"token function\">GetRequst</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http://localhost:8080/item\"</span><span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token function\">Expect</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">To</span><span class=\"token punctuation\">(</span><span class=\"token function\">BeNil</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token function\">Expect</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">To</span><span class=\"token punctuation\">(</span><span class=\"token function\">Equal</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"counter\"</span><span class=\"token punctuation\">:</span> counter<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\t<span class=\"token function\">Describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"get item from redis\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token function\">Context</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"wait 15 seconds and send GET request\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token function\">It</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"should be a 500 Internal Error response\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\ttime<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">15</span> <span class=\"token operator\">*</span> time<span class=\"token punctuation\">.</span>Second<span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> service<span class=\"token punctuation\">.</span><span class=\"token function\">GetRequst</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http://localhost:8080/item\"</span><span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token function\">Expect</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">NotTo</span><span class=\"token punctuation\">(</span><span class=\"token function\">BeNil</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre>\n<p>If we run tests we'll see next output:</p>\n<pre class=\"language-bash\" tabindex=\"0\"><code class=\"language-bash\">go run github.com/onsi/ginkgo/v2/ginkgo <span class=\"token parameter variable\">-vv</span> ./integration_tests/<span class=\"token punctuation\">..</span>.\nRunning Suite: IntegrationTests Suite - /Users/user/example/integration_tests\n<span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span>\nRandom Seed: <span class=\"token number\">1681140106</span>\n\nWill run <span class=\"token number\">3</span> of <span class=\"token number\">3</span> specs\n------------------------------\nIntegrationTests\n/Users/user/example/example/integration_tests/suite_test.go:19\n  put item to redis\n  /Users/user/example/example/integration_tests/suite_test.go:37\n    send POST request\n    /Users/user/example/example/integration_tests/suite_test.go:38\n      should be a <span class=\"token number\">200</span> OK response\n      /Users/user/example/example/integration_tests/suite_test.go:39\n  <span class=\"token operator\">></span> Enter <span class=\"token punctuation\">[</span>BeforeAll<span class=\"token punctuation\">]</span> IntegrationTests - /Users/user/example/example/integration_tests/suite_test.go:25 @ 04/10/23 <span class=\"token number\">17</span>:21:47.982\n  <span class=\"token operator\">&lt;</span> Exit <span class=\"token punctuation\">[</span>BeforeAll<span class=\"token punctuation\">]</span> IntegrationTests - /Users/user/example/example/integration_tests/suite_test.go:25 @ 04/10/23 <span class=\"token number\">17</span>:23:36.056 <span class=\"token punctuation\">(</span>1m48.075s<span class=\"token punctuation\">)</span>\n  <span class=\"token operator\">></span> Enter <span class=\"token punctuation\">[</span>It<span class=\"token punctuation\">]</span> should be a <span class=\"token number\">200</span> OK response - /Users/user/example/example/integration_tests/suite_test.go:39 @ 04/10/23 <span class=\"token number\">17</span>:23:36.057\n  <span class=\"token operator\">&lt;</span> Exit <span class=\"token punctuation\">[</span>It<span class=\"token punctuation\">]</span> should be a <span class=\"token number\">200</span> OK response - /Users/user/example/example/integration_tests/suite_test.go:39 @ 04/10/23 <span class=\"token number\">17</span>:23:36.068 <span class=\"token punctuation\">(</span>11ms<span class=\"token punctuation\">)</span>\n• <span class=\"token punctuation\">[</span><span class=\"token number\">108.087</span> seconds<span class=\"token punctuation\">]</span>\n------------------------------\nIntegrationTests\n/Users/user/example/example/integration_tests/suite_test.go:19\n  get item from redis\n  /Users/user/example/example/integration_tests/suite_test.go:48\n    send GET request\n    /Users/user/example/example/integration_tests/suite_test.go:49\n      should be a <span class=\"token number\">200</span> OK response\n      /Users/user/example/example/integration_tests/suite_test.go:50\n  <span class=\"token operator\">></span> Enter <span class=\"token punctuation\">[</span>It<span class=\"token punctuation\">]</span> should be a <span class=\"token number\">200</span> OK response - /Users/user/example/example/integration_tests/suite_test.go:50 @ 04/10/23 <span class=\"token number\">17</span>:23:36.069\n  <span class=\"token operator\">&lt;</span> Exit <span class=\"token punctuation\">[</span>It<span class=\"token punctuation\">]</span> should be a <span class=\"token number\">200</span> OK response - /Users/user/example/example/integration_tests/suite_test.go:50 @ 04/10/23 <span class=\"token number\">17</span>:23:36.07 <span class=\"token punctuation\">(</span>2ms<span class=\"token punctuation\">)</span>\n• <span class=\"token punctuation\">[</span><span class=\"token number\">0.002</span> seconds<span class=\"token punctuation\">]</span>\n------------------------------\nIntegrationTests\n/Users/user/example/example/integration_tests/suite_test.go:19\n  get item from redis\n  /Users/user/example/example/integration_tests/suite_test.go:58\n    <span class=\"token function\">wait</span> <span class=\"token number\">15</span> seconds and send GET request\n    /Users/user/example/example/integration_tests/suite_test.go:59\n      should be a <span class=\"token number\">500</span> Internal Error response\n      /Users/user/example/example/integration_tests/suite_test.go:60\n  <span class=\"token operator\">></span> Enter <span class=\"token punctuation\">[</span>It<span class=\"token punctuation\">]</span> should be a <span class=\"token number\">500</span> Internal Error response - /Users/user/example/example/integration_tests/suite_test.go:60 @ 04/10/23 <span class=\"token number\">17</span>:23:36.071\n<span class=\"token number\">2023</span>/04/10 <span class=\"token number\">17</span>:23:51 Could not call API: <span class=\"token number\">500</span> body: map<span class=\"token punctuation\">[</span>error:redis: nil<span class=\"token punctuation\">]</span>\n  <span class=\"token operator\">&lt;</span> Exit <span class=\"token punctuation\">[</span>It<span class=\"token punctuation\">]</span> should be a <span class=\"token number\">500</span> Internal Error response - /Users/user/example/example/integration_tests/suite_test.go:60 @ 04/10/23 <span class=\"token number\">17</span>:23:51.075 <span class=\"token punctuation\">(</span><span class=\"token number\">15</span>.005s<span class=\"token punctuation\">)</span>\n  <span class=\"token operator\">></span> Enter <span class=\"token punctuation\">[</span>AfterAll<span class=\"token punctuation\">]</span> IntegrationTests - /Users/user/example/example/integration_tests/suite_test.go:32 @ 04/10/23 <span class=\"token number\">17</span>:23:51.075\n  <span class=\"token operator\">&lt;</span> Exit <span class=\"token punctuation\">[</span>AfterAll<span class=\"token punctuation\">]</span> IntegrationTests - /Users/user/example/example/integration_tests/suite_test.go:32 @ 04/10/23 <span class=\"token number\">17</span>:23:51.736 <span class=\"token punctuation\">(</span>660ms<span class=\"token punctuation\">)</span>\n• <span class=\"token punctuation\">[</span><span class=\"token number\">15.665</span> seconds<span class=\"token punctuation\">]</span>\n------------------------------\n\nRan <span class=\"token number\">3</span> of <span class=\"token number\">3</span> Specs <span class=\"token keyword\">in</span> <span class=\"token number\">123.755</span> seconds\nSUCCESS<span class=\"token operator\">!</span> -- <span class=\"token number\">3</span> Passed <span class=\"token operator\">|</span> <span class=\"token number\">0</span> Failed <span class=\"token operator\">|</span> <span class=\"token number\">0</span> Pending <span class=\"token operator\">|</span> <span class=\"token number\">0</span> Skipped\nPASS\n\nGinkgo ran <span class=\"token number\">1</span> suite <span class=\"token keyword\">in</span> 2m4.977159458s\nTest Suite Passed</code></pre>\n<p>Our tests are well formatted, the output is very descriptive.\nThe <code>ginkgo</code> is able to generate <code>junit</code> report btw.</p>\n<p>I hope this article gives you a good idea of how to write integration tests for your <code>Golang</code> application.</p>\n<p>Happy coding!</p>\n",
			"date_published": "2023-04-10T00:00:00Z"
		}
		,
		{
			"id": "https://rkiselenko.dev/blog/tauri-solidjs-macos/",
			"url": "https://rkiselenko.dev/blog/tauri-solidjs-macos/",
			"title": "Try Tauri",
			"content_html": "<div class=\"message-box\">\n <p>Tauri is a polyglot and generic toolkit that is very composable and allows engineers to make a wide variety of applications.  It is used for building applications for desktop computers using a combination of Rust tools and HTML rendered in a Webview.</p>\n</div>\n<p>Sounds interesting and I decided to give it a try, and make a simple application for tracking cryptocurrency tickers from the Binance exchange.</p>\n<h1 id=\"setup\" tabindex=\"-1\">Setup <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/tauri-solidjs-macos/\">#</a></h1>\n<p>The first step is to install and create an application template.\nWe need <a href=\"https://www.rust-lang.org/tools/install\">rust</a> and <code>cargo</code> in order to generate our application scaffold (there are many other options for generation but since I'm starting to learn <code>rust</code> I will stick with it.)</p>\n<p>The easiest way to scaffold a new project is the <code>create-tauri-app</code> utility.</p>\n<pre class=\"language-shell\" tabindex=\"0\"><code class=\"language-shell\"><span class=\"token function\">cargo</span> <span class=\"token function\">install</span> create-tauri-app\n<span class=\"token function\">cargo</span> create-tauri-app \n✔ Project name · mycryptobar\n? Choose your package manager ›\n  <span class=\"token function\">cargo</span>\n❯ <span class=\"token function\">pnpm</span>\n  <span class=\"token function\">yarn</span>\n  <span class=\"token function\">npm</span></code></pre>\n<p>On this step generator asking us about prefer package manager for our frontend, there are two options:</p>\n<ul>\n<li>for handling frontend with <code>rust</code> trough <a href=\"https://yew.rs/\">yew</a> chose <code>cargo</code></li>\n<li>for handle frontend with <code>js</code> trough any modern js framework like <code>vue</code>, <code>svelte</code>, <code>react</code> and so on choose <code>pnpm</code>, <code>yarn</code>, <code>npm</code>.</li>\n</ul>\n<p>In my example I'll use <code>pnpm</code> as package manager, <a href=\"https://www.solidjs.com/\">solidjs</a> and <a href=\"https://tailwindcss.com/\">tailwind framework</a>.</p>\n<h1 id=\"scaffold\" tabindex=\"-1\">Scaffold <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/tauri-solidjs-macos/\">#</a></h1>\n<p>Generator create an application scaffold for us, there are two part <code>frontend</code> in our root folder and <code>backend</code> in <code>src-tauri</code> folder.\nWe will create system tray application and we need enable it in the <code>src-tauri/Cargo.toml</code>:</p>\n<pre class=\"language-git\" tabindex=\"0\"><code class=\"language-git\">diff --git a/src-tauri/Cargo.toml b/src-tauri/Cargo.toml\nindex f05fce3..6434503 100644\n<span class=\"token deleted\">--- a/src-tauri/Cargo.toml</span>\n<span class=\"token inserted\">+++ b/src-tauri/Cargo.toml</span>\n@@ -16,6 +16,7 @@ tauri-build = {version = <span class=\"token string\">\"1.2\"</span>, features = [] }\n [dependencies]\n serde_json = <span class=\"token string\">\"1.0\"</span>\n serde = { version = <span class=\"token string\">\"1.0\"</span>, features = [<span class=\"token string\">\"derive\"</span>] }\n<span class=\"token inserted\">+tauri = { version = \"1.2.1\", features = [\"http-request\", \"icon-png\", \"system-tray\"] }</span>\n \n [features]\n # by default Tauri runs in production mode</code></pre>\n<p>Add tray configuration to <code>src-tauri/tauri.conf.json</code>:</p>\n<pre class=\"language-git\" tabindex=\"0\"><code class=\"language-git\">diff --git a/src-tauri/src/main.rs b/src-tauri/src/main.rs\nindex e27813a..af057f4 100644\n<span class=\"token deleted\">--- a/src-tauri/src/main.rs</span>\n<span class=\"token inserted\">+++ b/src-tauri/src/main.rs</span>\n<span class=\"token coord\">@@ -3,6 +3,9 @@</span>\n     windows_subsystem = <span class=\"token string\">\"windows\"</span>\n )]\n \n<span class=\"token inserted\">+use tauri::SystemTray;</span>\n<span class=\"token inserted\">+use tauri::{CustomMenuItem, SystemTrayMenu, SystemTrayMenuItem};</span>\n<span class=\"token inserted\">+</span>\n // Learn more about Tauri commands at https://tauri.app/v1/guides/features/command\n #[tauri::command]\n fn greet(name: &amp;str) -> String {\n@@ -10,7 +13,17 @@ fn greet(name: &amp;str) -> String {\n }\n \n fn main() {\n<span class=\"token inserted\">+    let quit = CustomMenuItem::new(\"quit\".to_string(), \"Quit\");</span>\n<span class=\"token inserted\">+    let hide = CustomMenuItem::new(\"hide\".to_string(), \"Hide\");</span>\n<span class=\"token inserted\">+    let tray_menu = SystemTrayMenu::new()</span>\n<span class=\"token inserted\">+        .add_item(quit)</span>\n<span class=\"token inserted\">+        .add_native_item(SystemTrayMenuItem::Separator)</span>\n<span class=\"token inserted\">+        .add_item(hide);</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+    let system_tray = SystemTray::new()</span>\n<span class=\"token inserted\">+    .with_menu(tray_menu);</span>\n     tauri::Builder::default()\n<span class=\"token inserted\">+        .system_tray(system_tray)</span>\n         .invoke_handler(tauri::generate_handler![greet])\n         .run(tauri::generate_context!())\n         .expect(<span class=\"token string\">\"error while running tauri application\"</span>);\ndiff --git a/src-tauri/tauri.conf.json b/src-tauri/tauri.conf.json\nindex eaac219..0dbc746 100644\n<span class=\"token deleted\">--- a/src-tauri/tauri.conf.json</span>\n<span class=\"token inserted\">+++ b/src-tauri/tauri.conf.json</span>\n<span class=\"token coord\">@@ -52,6 +52,10 @@</span>\n     },\n     <span class=\"token string\">\"updater\"</span>: {\n       <span class=\"token string\">\"active\"</span>: false\n<span class=\"token inserted\">+    },</span>\n<span class=\"token inserted\">+     \"systemTray\": {</span>\n<span class=\"token inserted\">+      \"iconPath\": \"icons/icon.png\",</span>\n<span class=\"token inserted\">+      \"iconAsTemplate\": true</span>\n     },\n     <span class=\"token string\">\"windows\"</span>: [</code></pre>\n<p>Now lets test it, run <code>cargo tauri dev</code>:</p>\n<p><picture><source type=\"image/gif\" srcset=\"https://rkiselenko.dev/img/Wdhca272Ro-600.gif 600w\"><source type=\"image/avif\" srcset=\"https://rkiselenko.dev/img/Wdhca272Ro-600.avif 600w\"><source type=\"image/webp\" srcset=\"https://rkiselenko.dev/img/Wdhca272Ro-600.webp 600w\"><img alt=\"MacOS tauri example\" loading=\"lazy\" decoding=\"async\" src=\"https://rkiselenko.dev/img/Wdhca272Ro-600.png\" width=\"600\" height=\"471\"></picture></p>\n<h1 id=\"frontend\" tabindex=\"-1\">Frontend <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/tauri-solidjs-macos/\">#</a></h1>\n<p>Lets add some frontend code, first part with styles.\nInstall and generate tailwind our css framework:</p>\n<pre class=\"language-bash\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"token function\">pnpm</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-D</span> tailwindcss postcss autoprefixer\n<span class=\"token function\">pnpm</span> tailwindcss init <span class=\"token parameter variable\">-p</span>\n<span class=\"token function\">cat</span> tailwind.config.js\n/** @type <span class=\"token punctuation\">{</span>import<span class=\"token punctuation\">(</span><span class=\"token string\">'tailwindcss'</span><span class=\"token punctuation\">)</span>.Config<span class=\"token punctuation\">}</span> */\nmodule.exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  content: <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"./index.html\"</span>,\n    <span class=\"token string\">\"./src/**/*.{js,ts,jsx,tsx}\"</span>,\n  <span class=\"token punctuation\">]</span>,\n  theme: <span class=\"token punctuation\">{</span>\n    extend: <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>,\n  <span class=\"token punctuation\">}</span>,\n  plugins: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>,\n<span class=\"token punctuation\">}</span></code></pre>\n<p>A little bit css code for tailwind components <code>src/style.css</code>:</p>\n<pre class=\"language-css\" tabindex=\"0\"><code class=\"language-css\"><span class=\"token atrule\"><span class=\"token rule\">@tailwind</span> base<span class=\"token punctuation\">;</span></span>\n<span class=\"token atrule\"><span class=\"token rule\">@tailwind</span> components<span class=\"token punctuation\">;</span></span>\n<span class=\"token atrule\"><span class=\"token rule\">@tailwind</span> utilities<span class=\"token punctuation\">;</span></span></code></pre>\n<p>Next step add solidjs code for out frontend, in <code>src/App.jsx</code>, in this code we create a simple table component to render the response from binance exchange:</p>\n<pre class=\"language-js\" tabindex=\"0\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> invoke <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@tauri-apps/api/tauri\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> Item <span class=\"token keyword\">from</span> <span class=\"token string\">\"./Item\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createSignal<span class=\"token punctuation\">,</span> createEffect <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"solid-js\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> timeTicker <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> setCount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">createSignal</span><span class=\"token punctuation\">(</span>timeTicker<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>items<span class=\"token punctuation\">,</span> setItems<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">createSignal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">createEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> c <span class=\"token operator\">=</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>c <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"get_binance_ticker\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">setItems</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">equals</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>timeTicker<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"grid grid-rows-2 grid-flow-row font-source h-screen bg-background p-1\"</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"font-light\"</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"grid grid-cols-4 gap-4 h-4 content-center text-xs  text-slate-400\"</span><span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"col-span-2\"</span><span class=\"token operator\">></span>Pair<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"ml-auto\"</span><span class=\"token operator\">></span>Price<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"ml-auto\"</span><span class=\"token operator\">></span>24h<span class=\"token operator\">%</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>For each<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token function\">items</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n          <span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">item</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token operator\">&lt;</span>Item symbol<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>item<span class=\"token punctuation\">.</span>symbol<span class=\"token punctuation\">}</span> priceChangePercent<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>item<span class=\"token punctuation\">.</span>change<span class=\"token punctuation\">}</span> lastPrice<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>item<span class=\"token punctuation\">.</span>price<span class=\"token punctuation\">}</span><span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">}</span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>For<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"text-xs font-light text-slate-400\"</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"text-xs font-light text-slate-400 ml-auto\"</span><span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"col-span-2\"</span><span class=\"token operator\">></span>Updating <span class=\"token keyword\">in</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> App<span class=\"token punctuation\">;</span></code></pre>\n<p>Create a table item component <code>src/Item.jsx</code></p>\n<pre class=\"language-js\" tabindex=\"0\"><code class=\"language-js\"><span class=\"token keyword\">const</span> buttonClass <span class=\"token operator\">=</span> <span class=\"token string\">\"text-white font-bold uppercase shadow hover:shadow-md outline-none focus:outline-none ease-linear transition-all duration-150 px-2\"</span>\n<span class=\"token keyword\">const</span> greenButton <span class=\"token operator\">=</span> <span class=\"token string\">\"bg-green-500 \"</span>\n<span class=\"token keyword\">const</span> redButton <span class=\"token operator\">=</span> <span class=\"token string\">\"bg-red-500 \"</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">Item</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"grid grid-cols-4 gap-4 text-base h-6 content-center text-slate-700\"</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"col-span-2\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span><span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">.</span>symbol<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"ml-auto\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span><span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">.</span>lastPrice<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"ml-auto\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">.</span>priceChangePercent<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"-\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> redButton <span class=\"token operator\">:</span> greenButton<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> buttonClass<span class=\"token punctuation\">}</span><span class=\"token operator\">></span><span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">.</span>priceChangePercent<span class=\"token punctuation\">}</span><span class=\"token operator\">%</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h1 id=\"backend\" tabindex=\"-1\">Backend <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/tauri-solidjs-macos/\">#</a></h1>\n<p>Now the magic part is to call our <code>rust</code> backend and fetch the prices from exchange, tauri provide <a href=\"https://tauri.app/v1/guides/features/command\">a helper function</a> for this case <code>invoke</code>, install that helper:</p>\n<pre class=\"language-shell\" tabindex=\"0\"><code class=\"language-shell\"><span class=\"token function\">pnpm</span> <span class=\"token function\">add</span> @tauri-apps/api</code></pre>\n<p>Add to our frontend code <code>src/App.jsx</code>:</p>\n<pre class=\"language-js\" tabindex=\"0\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> invoke <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@tauri-apps/api/tauri\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// some code here</span>\n<span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"get_binance_ticker\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// some code here</span></code></pre>\n<p>And the <code>rust</code> part, firstly add library to make http calls <code>src-tauri/Cargo.toml</code>:</p>\n<pre class=\"language-yaml\" tabindex=\"0\"><code class=\"language-yaml\"><span class=\"token punctuation\">...</span>\nreqwest = <span class=\"token punctuation\">{</span> version = \"0.11.13\"<span class=\"token punctuation\">,</span> features = <span class=\"token punctuation\">[</span><span class=\"token string\">\"blocking\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"json\"</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">...</span></code></pre>\n<p>Next add to <code>rust</code> code a tauri command <code>get_binance_ticker</code> which returns the response from binance exchange, in our frontend code we have <code>invoke(&quot;get_binance_ticker&quot;)</code> function call.</p>\n<p><code>src-tauri/src/main.rs</code>:</p>\n<pre class=\"language-rust\" tabindex=\"0\"><code class=\"language-rust\"><span class=\"token attribute attr-name\">#![cfg_attr(\n    all(not(debug_assertions), target_os = <span class=\"token string\">\"windows\"</span>),\n    windows_subsystem = <span class=\"token string\">\"windows\"</span>\n)]</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">reqwest<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Url</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">serde<span class=\"token punctuation\">::</span></span><span class=\"token punctuation\">{</span><span class=\"token class-name\">Deserialize</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Serialize</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">tauri<span class=\"token punctuation\">::</span></span><span class=\"token punctuation\">{</span><span class=\"token class-name\">CustomMenuItem</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Manager</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">SystemTray</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">SystemTrayEvent</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">SystemTrayMenu</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token attribute attr-name\">#[derive(Serialize, Deserialize, Debug)]</span>\n<span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">ApiResponse</span> <span class=\"token punctuation\">{</span>\n    symbol<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span>\n    <span class=\"token attribute attr-name\">#[serde(rename(deserialize = <span class=\"token string\">\"lastPrice\"</span>))]</span>\n    price<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span>\n    <span class=\"token attribute attr-name\">#[serde(rename(deserialize = <span class=\"token string\">\"priceChangePercent\"</span>))]</span>\n    change<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token attribute attr-name\">#[tauri::command]</span>\n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">get_binance_ticker</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">ApiResponse</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> url <span class=\"token operator\">=</span> <span class=\"token string\">\"https://api.binance.com/api/v1/ticker/24hr?symbols=[%22BTCUSDT%22,%22BNBUSDT%22,%22ETHUSDT%22,%22XRPUSDT%22,%22DOGEUSDT%22,%22SHIBUSDT%22]\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> url <span class=\"token operator\">=</span> <span class=\"token class-name\">Url</span><span class=\"token punctuation\">::</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token operator\">*</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> res <span class=\"token operator\">=</span> <span class=\"token namespace\">reqwest<span class=\"token punctuation\">::</span>blocking<span class=\"token punctuation\">::</span></span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> items<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">ApiResponse</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{:?}\"</span><span class=\"token punctuation\">,</span> items<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    items\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token attribute attr-name\">#[tauri::command]</span>\n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">set_title</span><span class=\"token punctuation\">(</span>app_handle<span class=\"token punctuation\">:</span> <span class=\"token namespace\">tauri<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">AppHandle</span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">str</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token attribute attr-name\">#[cfg(target_os = <span class=\"token string\">\"macos\"</span>)]</span>\n    app_handle<span class=\"token punctuation\">.</span><span class=\"token function\">tray_handle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">set_title</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">create_tray</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token namespace\">tauri<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">App</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token namespace\">tauri<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Result</span><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> tray_menu <span class=\"token operator\">=</span> <span class=\"token class-name\">SystemTrayMenu</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">add_item</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CustomMenuItem</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"clear_title\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Clear Title\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">add_item</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CustomMenuItem</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"set_title\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Set Title\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">add_item</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CustomMenuItem</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"quit\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Quit\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> handle <span class=\"token operator\">=</span> app<span class=\"token punctuation\">.</span><span class=\"token function\">handle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> tray_id <span class=\"token operator\">=</span> <span class=\"token string\">\"cryptobar-tray\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">SystemTray</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">with_id</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>tray_id<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">with_menu</span><span class=\"token punctuation\">(</span>tray_menu<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">on_event</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">move</span> <span class=\"token closure-params\"><span class=\"token closure-punctuation punctuation\">|</span>event<span class=\"token closure-punctuation punctuation\">|</span></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> tray_handle <span class=\"token operator\">=</span> handle<span class=\"token punctuation\">.</span><span class=\"token function\">tray_handle_by_id</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>tray_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">match</span> event <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\">SystemTrayEvent</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">LeftClick</span> <span class=\"token punctuation\">{</span>\n                    position<span class=\"token punctuation\">:</span> _<span class=\"token punctuation\">,</span>\n                    size<span class=\"token punctuation\">:</span> _<span class=\"token punctuation\">,</span>\n                    <span class=\"token punctuation\">..</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"left click\"</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token class-name\">SystemTrayEvent</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">MenuItemClick</span> <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">..</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token comment\">// let item_handle = tray_handle.get_item(&amp;id);</span>\n                    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"menu click\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">match</span> id<span class=\"token punctuation\">.</span><span class=\"token function\">as_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token string\">\"quit\"</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token comment\">// exit the app</span>\n                            handle<span class=\"token punctuation\">.</span><span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span>\n                        <span class=\"token string\">\"clear_title\"</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token attribute attr-name\">#[cfg(target_os = <span class=\"token string\">\"macos\"</span>)]</span>\n                            tray_handle<span class=\"token punctuation\">.</span><span class=\"token function\">set_title</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span>\n                        <span class=\"token string\">\"set_title\"</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token attribute attr-name\">#[cfg(target_os = <span class=\"token string\">\"macos\"</span>)]</span>\n                            tray_handle<span class=\"token punctuation\">.</span><span class=\"token function\">set_title</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Tauri\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span>\n                        _ <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n                _ <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token closure-params\"><span class=\"token closure-punctuation punctuation\">|</span>_<span class=\"token closure-punctuation punctuation\">|</span></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token namespace\">tauri<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Builder</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">setup</span><span class=\"token punctuation\">(</span><span class=\"token closure-params\"><span class=\"token closure-punctuation punctuation\">|</span>app<span class=\"token closure-punctuation punctuation\">|</span></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">create_tray</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">Ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">on_system_tray_event</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">move</span> <span class=\"token closure-params\"><span class=\"token closure-punctuation punctuation\">|</span>app<span class=\"token punctuation\">,</span> event<span class=\"token closure-punctuation punctuation\">|</span></span> <span class=\"token keyword\">match</span> event <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">SystemTrayEvent</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">LeftClick</span> <span class=\"token punctuation\">{</span> position<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">..</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">let</span> w <span class=\"token operator\">=</span> app<span class=\"token punctuation\">.</span><span class=\"token function\">get_window</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"main\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">let</span> visible <span class=\"token operator\">=</span> w<span class=\"token punctuation\">.</span><span class=\"token function\">is_visible</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span> visible <span class=\"token punctuation\">{</span>\n                    w<span class=\"token punctuation\">.</span><span class=\"token function\">hide</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                    w<span class=\"token punctuation\">.</span><span class=\"token function\">show</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    w<span class=\"token punctuation\">.</span><span class=\"token function\">set_focus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n            _ <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">on_window_event</span><span class=\"token punctuation\">(</span><span class=\"token closure-params\"><span class=\"token closure-punctuation punctuation\">|</span>event<span class=\"token closure-punctuation punctuation\">|</span></span> <span class=\"token keyword\">match</span> event<span class=\"token punctuation\">.</span><span class=\"token function\">event</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token namespace\">tauri<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">WindowEvent</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">CloseRequested</span> <span class=\"token punctuation\">{</span> api<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">..</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// don't kill the app when the user clicks close. this is important</span>\n                <span class=\"token comment\">// event.window().hide().unwrap();</span>\n                <span class=\"token comment\">// api.prevent_close();</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token namespace\">tauri<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">WindowEvent</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Focused</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// hide the window automatically when the user</span>\n                <span class=\"token comment\">// clicks out. this is for a matter of taste.</span>\n                <span class=\"token comment\">// event.window().hide().unwrap();</span>\n            <span class=\"token punctuation\">}</span>\n            _ <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">invoke_handler</span><span class=\"token punctuation\">(</span><span class=\"token namespace\">tauri<span class=\"token punctuation\">::</span></span><span class=\"token macro property\">generate_handler!</span><span class=\"token punctuation\">[</span>set_title<span class=\"token punctuation\">,</span> get_binance_ticker<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token namespace\">tauri<span class=\"token punctuation\">::</span></span><span class=\"token macro property\">generate_context!</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error while running tauri application\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h1 id=\"overview\" tabindex=\"-1\">Overview <a class=\"header-anchor\" href=\"https://rkiselenko.dev/blog/tauri-solidjs-macos/\">#</a></h1>\n<p>If all steps above was successfull now we have a very basic GUI application build with <code>tauri</code>.</p>\n<p><picture><source type=\"image/gif\" srcset=\"https://rkiselenko.dev/img/mvWPXpvWXT-600.gif 600w\"><source type=\"image/avif\" srcset=\"https://rkiselenko.dev/img/mvWPXpvWXT-600.avif 600w\"><source type=\"image/webp\" srcset=\"https://rkiselenko.dev/img/mvWPXpvWXT-600.webp 600w\"><img alt=\"MacOS tauri example\" loading=\"lazy\" decoding=\"async\" src=\"https://rkiselenko.dev/img/mvWPXpvWXT-600.png\" width=\"600\" height=\"716\"></picture></p>\n<p>You can play with tray functionalities, create <a href=\"https://tauri.app/v1/guides/features/multiwindow\">multiwindow application</a> and ship it <a href=\"https://tauri.app/v1/guides/building/\">for many platforms</a>.</p>\n<p>Happy coding!</p>\n",
			"date_published": "2022-12-08T16:42:57Z"
		}
		,
		{
			"id": "https://rkiselenko.dev/blog/afero-for-testing/",
			"url": "https://rkiselenko.dev/blog/afero-for-testing/",
			"title": "Test file uploads with afero in Golang",
			"content_html": "<p>Suppose we have a simple file upload http handler that looks like this:</p>\n<pre class=\"language-go\" tabindex=\"0\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"fmt\"</span>\n\t<span class=\"token string\">\"io\"</span>\n\t<span class=\"token string\">\"log\"</span>\n\t<span class=\"token string\">\"net/http\"</span>\n\t<span class=\"token string\">\"os\"</span>\n\n\t<span class=\"token string\">\"github.com/gorilla/mux\"</span>\n\t<span class=\"token string\">\"github.com/rs/cors\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> MB <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">20</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\tr <span class=\"token operator\">:=</span> <span class=\"token operator\">&amp;</span>Router<span class=\"token punctuation\">{</span><span class=\"token operator\">&amp;</span>mux<span class=\"token punctuation\">.</span>Router<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n\tr<span class=\"token punctuation\">.</span><span class=\"token function\">MustResponse</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"POST\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">processFile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n\tr<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token string\">\":8080\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"*\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">processFile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> http<span class=\"token punctuation\">.</span>HandlerFunc <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">HandlerFunc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>res http<span class=\"token punctuation\">.</span>ResponseWriter<span class=\"token punctuation\">,</span> req <span class=\"token operator\">*</span>http<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> req<span class=\"token punctuation\">.</span><span class=\"token function\">ParseMultipartForm</span><span class=\"token punctuation\">(</span><span class=\"token number\">50</span> <span class=\"token operator\">*</span> MB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token boolean\">nil</span> <span class=\"token operator\">!=</span> err <span class=\"token punctuation\">{</span>\n\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"while parse %s\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t\t\tres<span class=\"token punctuation\">.</span><span class=\"token function\">WriteHeader</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusInternalServerError<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">return</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token keyword\">defer</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\terr <span class=\"token operator\">:=</span> req<span class=\"token punctuation\">.</span>MultipartForm<span class=\"token punctuation\">.</span><span class=\"token function\">RemoveAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Cant delete multipart error %s\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\t\t<span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> fheaders <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> req<span class=\"token punctuation\">.</span>MultipartForm<span class=\"token punctuation\">.</span>File <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> hdr <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> fheaders <span class=\"token punctuation\">{</span>\n\t\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Income file name: %s\"</span><span class=\"token punctuation\">,</span> hdr<span class=\"token punctuation\">.</span>Filename<span class=\"token punctuation\">)</span>\n\n\t\t\t\tinfile<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> hdr<span class=\"token punctuation\">.</span><span class=\"token function\">Open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Handle open error: %v\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t\t\t\t\tres<span class=\"token punctuation\">.</span><span class=\"token function\">WriteHeader</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusInternalServerError<span class=\"token punctuation\">)</span>\n\t\t\t\t\t<span class=\"token keyword\">continue</span>\n\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t\t<span class=\"token keyword\">defer</span> infile<span class=\"token punctuation\">.</span><span class=\"token function\">Close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\t\t\t\tf<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> os<span class=\"token punctuation\">.</span><span class=\"token function\">OpenFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./downloaded\"</span><span class=\"token punctuation\">,</span> os<span class=\"token punctuation\">.</span>O_WRONLY<span class=\"token operator\">|</span>os<span class=\"token punctuation\">.</span>O_CREATE<span class=\"token punctuation\">,</span> <span class=\"token number\">0666</span><span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Create Read Input error %v\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t\t\t\t\tres<span class=\"token punctuation\">.</span><span class=\"token function\">WriteHeader</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>StatusInternalServerError<span class=\"token punctuation\">)</span>\n\t\t\t\t\t<span class=\"token keyword\">continue</span>\n\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t\t<span class=\"token keyword\">defer</span> f<span class=\"token punctuation\">.</span><span class=\"token function\">Close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t\t\tio<span class=\"token punctuation\">.</span><span class=\"token function\">Copy</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> infile<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\tres<span class=\"token punctuation\">.</span><span class=\"token function\">Header</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Content-Type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"text/html\"</span><span class=\"token punctuation\">)</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Fprint</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">,</span> <span class=\"token string\">\"&lt;h2>Success&lt;/h2>\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">type</span> Router <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token operator\">*</span>mux<span class=\"token punctuation\">.</span>Router\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>r <span class=\"token operator\">*</span>Router<span class=\"token punctuation\">)</span> <span class=\"token function\">MustResponse</span><span class=\"token punctuation\">(</span>meth<span class=\"token punctuation\">,</span> path <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> h http<span class=\"token punctuation\">.</span>HandlerFunc<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\tr<span class=\"token punctuation\">.</span><span class=\"token function\">HandleFunc</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Methods</span><span class=\"token punctuation\">(</span>meth<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>r <span class=\"token operator\">*</span>Router<span class=\"token punctuation\">)</span> <span class=\"token function\">Run</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">,</span> origins <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\tc <span class=\"token operator\">:=</span> cors<span class=\"token punctuation\">.</span><span class=\"token function\">New</span><span class=\"token punctuation\">(</span>cors<span class=\"token punctuation\">.</span>Options<span class=\"token punctuation\">{</span>\n\t\tAllowedOrigins<span class=\"token punctuation\">:</span>   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">{</span>origins<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\tAllowedMethods<span class=\"token punctuation\">:</span>   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"POST\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"GET\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"OPTIONS\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"PUT\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"DELETE\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\tAllowedHeaders<span class=\"token punctuation\">:</span>   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"Accept\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Content-Type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"If-None-Match\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Content-Length\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Accept-Encoding\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Authorization\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\tAllowCredentials<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\thandler <span class=\"token operator\">:=</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">Handler</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">)</span>\n\thttp<span class=\"token punctuation\">.</span><span class=\"token function\">ListenAndServe</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">vars</span><span class=\"token punctuation\">(</span>req <span class=\"token operator\">*</span>http<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span> mux<span class=\"token punctuation\">.</span><span class=\"token function\">Vars</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>The code above is a common way to upload files to the server. The code below is for testing:</p>\n<pre class=\"language-go\" tabindex=\"0\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"bytes\"</span>\n\t<span class=\"token string\">\"io\"</span>\n\t<span class=\"token string\">\"mime/multipart\"</span>\n\t<span class=\"token string\">\"net/http\"</span>\n\t<span class=\"token string\">\"net/http/httptest\"</span>\n\t<span class=\"token string\">\"os\"</span>\n\t<span class=\"token string\">\"testing\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">TestMain</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">*</span>testing<span class=\"token punctuation\">.</span>T<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\tfilePath <span class=\"token operator\">:=</span> <span class=\"token string\">\"file.jpg\"</span>\n\tfieldName <span class=\"token operator\">:=</span> <span class=\"token string\">\"file\"</span>\n\tbody <span class=\"token operator\">:=</span> <span class=\"token function\">new</span><span class=\"token punctuation\">(</span>bytes<span class=\"token punctuation\">.</span>Buffer<span class=\"token punctuation\">)</span>\n\tmw <span class=\"token operator\">:=</span> multipart<span class=\"token punctuation\">.</span><span class=\"token function\">NewWriter</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span>\n\tfile<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> os<span class=\"token punctuation\">.</span><span class=\"token function\">Open</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tt<span class=\"token punctuation\">.</span><span class=\"token function\">Fatal</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\tw<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> mw<span class=\"token punctuation\">.</span><span class=\"token function\">CreateFormFile</span><span class=\"token punctuation\">(</span>fieldName<span class=\"token punctuation\">,</span> filePath<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tt<span class=\"token punctuation\">.</span><span class=\"token function\">Fatal</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> io<span class=\"token punctuation\">.</span><span class=\"token function\">Copy</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tt<span class=\"token punctuation\">.</span><span class=\"token function\">Fatal</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\tmw<span class=\"token punctuation\">.</span><span class=\"token function\">Close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\treq <span class=\"token operator\">:=</span> httptest<span class=\"token punctuation\">.</span><span class=\"token function\">NewRequest</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">.</span>MethodPost<span class=\"token punctuation\">,</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> body<span class=\"token punctuation\">)</span>\n\treq<span class=\"token punctuation\">.</span>Header<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Content-Type\"</span><span class=\"token punctuation\">,</span> mw<span class=\"token punctuation\">.</span><span class=\"token function\">FormDataContentType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\tres <span class=\"token operator\">:=</span> httptest<span class=\"token punctuation\">.</span><span class=\"token function\">NewRecorder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\thandler <span class=\"token operator\">:=</span> <span class=\"token function\">processFile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\thandler<span class=\"token punctuation\">.</span><span class=\"token function\">ServeHTTP</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">,</span> req<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> res<span class=\"token punctuation\">.</span>Code <span class=\"token operator\">!=</span> <span class=\"token number\">200</span> <span class=\"token punctuation\">{</span>\n\t\tt<span class=\"token punctuation\">.</span><span class=\"token function\">Errorf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Expected %d, received %d\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">.</span>Code<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>The problem here is that our test is actually working with the real filesystem.\nWe need a bunch of things in order to have the desired result.</p>\n<ul>\n<li>it needs an actual file to upload</li>\n<li>we should check uploaded file saved without errors</li>\n<li>we should have a cleanup procedure in order to delete saved file</li>\n</ul>\n<p>There is a way to test our handler without access to the real filesystem.\nThe <a href=\"https://github.com/spf13/afero\">afero</a> can help here.</p>\n<blockquote>\n<p>The MemMapFs backend is perfect for testing.</p>\n</blockquote>\n<ul>\n<li>Much faster than performing I/O operations on disk</li>\n<li>Avoid security issues and permissions</li>\n<li>Far more control. <code>rm -rf /</code> with confidence</li>\n<li>Test setup is far more easier to do</li>\n<li>No test cleanup needed</li>\n</ul>\n<p>The output of our test:</p>\n<pre class=\"language-shell\" tabindex=\"0\"><code class=\"language-shell\">Running tool: /usr/bin/go <span class=\"token builtin class-name\">test</span> <span class=\"token parameter variable\">-timeout</span> 30s <span class=\"token parameter variable\">-run</span> ^TestMain$ httptestfs <span class=\"token parameter variable\">-v</span>\n\n<span class=\"token operator\">==</span><span class=\"token operator\">=</span> RUN   TestMain\n<span class=\"token number\">2022</span>/01/13 <span class=\"token number\">15</span>:24:21 Income file: file.jpg\n--- PASS: TestMain <span class=\"token punctuation\">(</span><span class=\"token number\">0</span>.00s<span class=\"token punctuation\">)</span>\nPASS\nok  \thttptestfs\t<span class=\"token number\">0</span>.002s</code></pre>\n<p>After tests, the saved file is in the directory exactly how our handler processes it.</p>\n<p>Now let's use <code>afero</code>!</p>\n<pre class=\"language-git\" tabindex=\"0\"><code class=\"language-git\">diff --git main.go main.go\nindex 999fe42..2157943 100644\n<span class=\"token deleted\">--- main.go</span>\n<span class=\"token inserted\">+++ main.go</span>\n@@ -9,6 +9,7 @@ import (\n\n        <span class=\"token string\">\"github.com/gorilla/mux\"</span>\n        <span class=\"token string\">\"github.com/rs/cors\"</span>\n<span class=\"token inserted\">+       \"github.com/spf13/afero\"</span>\n )\n\n const MB = 1 &lt;&lt; 20\n@@ -16,12 +17,14 @@ const MB = 1 &lt;&lt; 20\n func main() {\n        r := &amp;Router{&amp;mux.Router{}}\n\n<span class=\"token deleted\">-       r.MustResponse(\"POST\", \"/\", processFile())</span>\n<span class=\"token inserted\">+       var AppFs = afero.NewOsFs()</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+       r.MustResponse(\"POST\", \"/\", processFile(AppFs))</span>\n\n        r.Run(<span class=\"token string\">\":8080\"</span>, <span class=\"token string\">\"*\"</span>)\n }\n\n<span class=\"token deleted\">-func processFile() http.HandlerFunc {</span>\n<span class=\"token inserted\">+func processFile(fs afero.Fs) http.HandlerFunc {</span>\n        return http.HandlerFunc(func(res http.ResponseWriter, req *http.Request) {\n                if err := req.ParseMultipartForm(50 * MB); nil != err {\n                        log.Printf(<span class=\"token string\">\"while parse %s\"</span>, err)\n@@ -38,7 +41,7 @@ func processFile() http.HandlerFunc {\n\n                for _, fheaders := range req.MultipartForm.File {\n                        for _, hdr := range fheaders {\n<span class=\"token deleted\">-                               log.Printf(\"Income file len: %d\", hdr.Size)</span>\n<span class=\"token inserted\">+                               log.Printf(\"Income file: %s\", hdr.Filename)</span>\n\n                                infile, err := hdr.Open()\n                                if err != nil {\n@@ -48,7 +51,7 @@ func processFile() http.HandlerFunc {\n                                }\n                                defer infile.Close()\n\n<span class=\"token deleted\">-                               f, err := os.OpenFile(\"./downloaded\", os.O_WRONLY|os.O_CREATE, 0666)</span>\n<span class=\"token inserted\">+                               f, err := fs.OpenFile(\"./downloaded\", os.O_WRONLY|os.O_CREATE, 0666)</span>\n                                if err != nil {\n                                        log.Printf(<span class=\"token string\">\"Create Read Input error %v\"</span>, err)\n                                        res.WriteHeader(http.StatusInternalServerError)\ndiff --git main_test.go main_test.go\nindex d3875bf..66739c7 100644\n<span class=\"token deleted\">--- main_test.go</span>\n<span class=\"token inserted\">+++ main_test.go</span>\n@@ -8,14 +8,19 @@ import (\n        <span class=\"token string\">\"net/http/httptest\"</span>\n        <span class=\"token string\">\"os\"</span>\n        <span class=\"token string\">\"testing\"</span>\n<span class=\"token inserted\">+</span>\n<span class=\"token inserted\">+       \"github.com/spf13/afero\"</span>\n )\n\n func TestMain(t *testing.T) {\n        filePath := <span class=\"token string\">\"file.jpg\"</span>\n        fieldName := <span class=\"token string\">\"file\"</span>\n<span class=\"token inserted\">+       var AppFs = afero.NewMemMapFs()</span>\n<span class=\"token inserted\">+</span>\n        body := new(bytes.Buffer)\n        mw := multipart.NewWriter(body)\n<span class=\"token deleted\">-       file, err := os.Open(filePath)</span>\n<span class=\"token inserted\">+       afero.WriteFile(AppFs, filePath, []byte(\"hello world\"), 0644)</span>\n<span class=\"token inserted\">+       file, err := AppFs.Create(filePath)</span>\n        if err != nil {\n                t.Fatal(err)\n        }\n@@ -32,10 +37,15 @@ func TestMain(t *testing.T) {\n        req := httptest.NewRequest(http.MethodPost, <span class=\"token string\">\"/\"</span>, body)\n        req.Header.Add(<span class=\"token string\">\"Content-Type\"</span>, mw.FormDataContentType())\n        res := httptest.NewRecorder()\n<span class=\"token deleted\">-       handler := processFile()</span>\n<span class=\"token inserted\">+       handler := processFile(AppFs)</span>\n\n        handler.ServeHTTP(res, req)\n        if res.Code != 200 {\n                t.Errorf(<span class=\"token string\">\"Expected %d, received %d\"</span>, 200, res.Code)\n        }\n<span class=\"token inserted\">+       fileName := \"downloaded\"</span>\n<span class=\"token inserted\">+       _, err = AppFs.Stat(fileName)</span>\n<span class=\"token inserted\">+       if os.IsNotExist(err) {</span>\n<span class=\"token inserted\">+               t.Errorf(\"file \\\"%s\\\" does not exist.\\n\", fileName)</span>\n<span class=\"token inserted\">+       }</span></code></pre>\n<p>With a little change, we create a mock filesystem for testing purposes. Let's run new tests.</p>\n<pre class=\"language-shell\" tabindex=\"0\"><code class=\"language-shell\">Running tool: /usr/bin/go <span class=\"token builtin class-name\">test</span> <span class=\"token parameter variable\">-timeout</span> 30s <span class=\"token parameter variable\">-run</span> ^TestMain$ httptestfs <span class=\"token parameter variable\">-v</span>\n\n<span class=\"token operator\">==</span><span class=\"token operator\">=</span> RUN   TestMain\n<span class=\"token number\">2022</span>/01/13 <span class=\"token number\">15</span>:24:21 Income file: file.jpg\n--- PASS: TestMain <span class=\"token punctuation\">(</span><span class=\"token number\">0</span>.00s<span class=\"token punctuation\">)</span>\nPASS\nok  \thttptestfs\t<span class=\"token number\">0</span>.002s</code></pre>\n<p>It's pass! Let's break our handler to check if tests actually works.</p>\n<pre class=\"language-git\" tabindex=\"0\"><code class=\"language-git\">\n<span class=\"token deleted\">- f, err := os.OpenFile(\"./downloaded\", os.O_WRONLY|os.O_CREATE, 0666)</span>\n<span class=\"token inserted\">+ f, err := fs.OpenFile(\"./download\", os.O_WRONLY|os.O_CREATE, 0666)</span>\n                                if err != nil {</code></pre>\n<p>Tests fails due to not exist file. Just as we want.</p>\n<pre class=\"language-shell\" tabindex=\"0\"><code class=\"language-shell\">Running tool: /usr/bin/go <span class=\"token builtin class-name\">test</span> <span class=\"token parameter variable\">-timeout</span> 30s <span class=\"token parameter variable\">-run</span> ^TestMain$ httptestfs <span class=\"token parameter variable\">-v</span>\n\n<span class=\"token operator\">==</span><span class=\"token operator\">=</span> RUN   TestMain\n<span class=\"token number\">2022</span>/01/13 <span class=\"token number\">15</span>:31:55 Income file: file.jpg\n    /home/user/dev/httpfs/main_test.go:49: <span class=\"token function\">file</span> <span class=\"token string\">\"downloaded\"</span> does not exist.\n--- FAIL: TestMain <span class=\"token punctuation\">(</span><span class=\"token number\">0</span>.00s<span class=\"token punctuation\">)</span>\nFAIL\nFAIL\thttptestfs\t<span class=\"token number\">0</span>.002s</code></pre>\n<p>Happy coding!</p>\n",
			"date_published": "2022-01-13T11:02:57Z"
		}
		,
		{
			"id": "https://rkiselenko.dev/blog/go-embed-usecase/",
			"url": "https://rkiselenko.dev/blog/go-embed-usecase/",
			"title": "One file web application in Golang",
			"content_html": "<p>With the version 1.16 we have a way to include in the binary an arbitrary files at compile time using <a href=\"https://golang.org/pkg/embed/\">embed</a> standard package.</p>\n<blockquote>\n<p>Package embed provides access to files embedded in the running Go program.</p>\n</blockquote>\n<p>That feature is very useful in order to create a one-file web application.</p>\n<p>There are many libs provides that way, for example: <a href=\"https://github.com/markbates/pkger\">pkger</a>, <a href=\"https://github.com/GeertJohan/go.rice\">go.rice</a> <a href=\"https://github.com/jteeuwen/go-bindata\">go-bindata</a>.</p>\n<p>In this post, I'll describe how to do it without external dependencies.</p>\n<p>The main goal is to have a file that we can run with no additional dependencies and a runtime environment.</p>\n<p>There are many applications built in the same way, for examplee:</p>\n<ul>\n<li><a href=\"https://github.com/filebrowser/filebrowser\">filebrowser</a></li>\n<li><a href=\"https://github.com/gogs/gogs\">gogs</a></li>\n</ul>\n<p>Let's embed the directory <code>embed</code> with two files inside: <code>index.html</code> and <code>styles.css</code>.</p>\n<pre class=\"language-html\" tabindex=\"0\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span><span class=\"token punctuation\">></span></span>\n\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span>\n\t\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>Title<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span>\n\t\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>stylesheet<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>styles.css<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span>\n\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\n\t\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span>This is a header<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span>\n\t\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span>The body has lightblue color<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span>\n\t\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>hr</span><span class=\"token punctuation\">></span></span>\n\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre>\n<pre class=\"language-css\" tabindex=\"0\"><code class=\"language-css\"><span class=\"token selector\">body</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> lightblue<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token selector\">h1</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">color</span><span class=\"token punctuation\">:</span> navy<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">margin-left</span><span class=\"token punctuation\">:</span> 20px<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>I have created a simple <code>main.go</code>, it looks as follows:</p>\n<pre class=\"language-go\" tabindex=\"0\"><code class=\"language-go\"><span class=\"token keyword\">package</span> main\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"fmt\"</span>\n\t<span class=\"token string\">\"net/http\"</span>\n\n\t<span class=\"token string\">\"embed\"</span>\n\n\t<span class=\"token string\">\"github.com/gorilla/mux\"</span>\n\t<span class=\"token string\">\"github.com/rs/cors\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">//go:embed embed/*</span>\n\n<span class=\"token keyword\">var</span> content embed<span class=\"token punctuation\">.</span>FS\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\tr <span class=\"token operator\">:=</span> <span class=\"token operator\">&amp;</span>Router<span class=\"token punctuation\">{</span><span class=\"token operator\">&amp;</span>mux<span class=\"token punctuation\">.</span>Router<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n\tr<span class=\"token punctuation\">.</span><span class=\"token function\">MustResponse</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"GET\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>res http<span class=\"token punctuation\">.</span>ResponseWriter<span class=\"token punctuation\">,</span> req <span class=\"token operator\">*</span>http<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tdata<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> content<span class=\"token punctuation\">.</span><span class=\"token function\">ReadFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"embed/index.html\"</span><span class=\"token punctuation\">)</span>\n\t\tres<span class=\"token punctuation\">.</span><span class=\"token function\">Header</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Content-Type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"text/html\"</span><span class=\"token punctuation\">)</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Fprint</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">,</span> <span class=\"token function\">string</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\tr<span class=\"token punctuation\">.</span><span class=\"token function\">MustResponse</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"GET\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/styles.css\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>res http<span class=\"token punctuation\">.</span>ResponseWriter<span class=\"token punctuation\">,</span> req <span class=\"token operator\">*</span>http<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tdata<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> content<span class=\"token punctuation\">.</span><span class=\"token function\">ReadFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"embed/styles.css\"</span><span class=\"token punctuation\">)</span>\n\t\tres<span class=\"token punctuation\">.</span><span class=\"token function\">Header</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Content-Type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"text/css\"</span><span class=\"token punctuation\">)</span>\n\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Fprint</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">,</span> <span class=\"token function\">string</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\tr<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token string\">\":8080\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"*\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">type</span> Router <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token operator\">*</span>mux<span class=\"token punctuation\">.</span>Router\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>r <span class=\"token operator\">*</span>Router<span class=\"token punctuation\">)</span> <span class=\"token function\">MustResponse</span><span class=\"token punctuation\">(</span>meth<span class=\"token punctuation\">,</span> path <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> h http<span class=\"token punctuation\">.</span>HandlerFunc<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\tr<span class=\"token punctuation\">.</span><span class=\"token function\">HandleFunc</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Methods</span><span class=\"token punctuation\">(</span>meth<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>r <span class=\"token operator\">*</span>Router<span class=\"token punctuation\">)</span> <span class=\"token function\">Run</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">,</span> origins <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\tc <span class=\"token operator\">:=</span> cors<span class=\"token punctuation\">.</span><span class=\"token function\">New</span><span class=\"token punctuation\">(</span>cors<span class=\"token punctuation\">.</span>Options<span class=\"token punctuation\">{</span>\n\t\tAllowedOrigins<span class=\"token punctuation\">:</span>   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">{</span>origins<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\tAllowedMethods<span class=\"token punctuation\">:</span>   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"POST\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"GET\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"OPTIONS\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"PUT\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"DELETE\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\tAllowedHeaders<span class=\"token punctuation\">:</span>   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"Accept\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Content-Type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"If-None-Match\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Content-Length\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Accept-Encoding\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Authorization\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\tAllowCredentials<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\thandler <span class=\"token operator\">:=</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">Handler</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">)</span>\n\thttp<span class=\"token punctuation\">.</span><span class=\"token function\">ListenAndServe</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">vars</span><span class=\"token punctuation\">(</span>req <span class=\"token operator\">*</span>http<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span> mux<span class=\"token punctuation\">.</span><span class=\"token function\">Vars</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Compile code with command <code>go build main.go</code> and run it <code>./main</code>. Open browser at address <code>http://localhost:8080</code> you'll see a page like below:</p>\n<p><picture><source type=\"image/gif\" srcset=\"https://rkiselenko.dev/img/fGQCmny1-5-692.gif 692w\"><source type=\"image/avif\" srcset=\"https://rkiselenko.dev/img/fGQCmny1-5-692.avif 692w\"><source type=\"image/webp\" srcset=\"https://rkiselenko.dev/img/fGQCmny1-5-692.webp 692w\"><img alt=\"An example image rendered from golang source code\" loading=\"lazy\" decoding=\"async\" src=\"https://rkiselenko.dev/img/fGQCmny1-5-692.png\" width=\"692\" height=\"256\"></picture></p>\n<p>Currently, we have one executable file with index.html and styles.css embedded in the binary.</p>\n<p>Feel free to play around. For example, you can include some rich js frameworks like <a href=\"https://nuxtjs.org/\">Nuxt</a>.</p>\n<p>Happy coding!</p>\n",
			"date_published": "2021-02-22T11:02:57Z"
		}
		
	]
}
